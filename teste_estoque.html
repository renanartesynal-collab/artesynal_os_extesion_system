<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Materiais - Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* ==========================================================================
           1. VARI√ÅVEIS DE CORES E ESTILOS GERAIS
           ========================================================================== */
        :root {
            --orange: #ff6b00;
            --dark-bg: #0a0a0a;
            --card-bg: #121212;
            --input-bg: #1a1a1a;
            --text-gray: #a0a0a0;
            --white: #ffffff;
            --red-cancel: #ff3b3b;
            --green-new: #22c55e;
            --blue-used: #3b82f6;
            --purple: #9b59b6;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--dark-bg);
            color: var(--white);
            margin: 0; padding: 0;
            overflow-x: hidden;
        }

        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        /* ==========================================================================
           2. TELA DE SELE√á√ÉO INICIAL (IMPRESS√ÉO OU SERRALHERIA)
           ========================================================================== */
        #sector-screen { display: flex; height: 100vh; width: 100%; align-items: center; justify-content: center; gap: 30px; position: fixed; top: 0; left: 0; background: var(--dark-bg); z-index: 1000; flex-wrap: wrap; padding: 20px;}
        .sector-btn { width: 300px; height: 200px; border-radius: 15px; border: none; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; font-family: inherit; transition: transform 0.2s; color: white;}
        .sector-btn:hover { transform: scale(1.05); }
        .sec-imp { background: linear-gradient(135deg, #8e44ad, #2980b9); box-shadow: 0 0 20px rgba(142, 68, 173, 0.4); }
        .sec-serr { background: linear-gradient(135deg, var(--orange), #d35400); box-shadow: 0 0 20px rgba(255, 107, 0, 0.4); }
        .sec-icon { font-size: 50px; margin-bottom: 10px; }
        .sec-title { font-size: 24px; font-weight: 900; text-transform: uppercase; }

        /* ==========================================================================
           3. LAYOUT PRINCIPAL E KANBAN (COLUNAS)
           ========================================================================== */
        #main-layout { display: none; padding: 20px; }
        .header-est { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #333; padding-bottom: 15px; }
        h1 { margin: 0; color: var(--white); font-size: 24px; text-transform: uppercase; font-weight: 900; }
        .btn-voltar { cursor: pointer; color: white; background: #333; padding: 10px 20px; border-radius: 8px; font-size: 12px; font-weight: bold; border:none; transition: 0.2s; }
        .btn-voltar:hover { background: #555; }

        .kanban-container { display: flex; gap: 20px; overflow-x: auto; padding-bottom: 20px; align-items: flex-start; }
        .kanban-col { background: #161616; border-radius: 10px; padding: 15px; min-width: 320px; width: 320px; border: 1px solid #222; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .kanban-header { padding: 12px; font-weight: 900; font-size: 13px; border-radius: 6px; margin-bottom: 15px; color: white; text-transform: uppercase; text-align: center; }
        
        .hdr-imp { background: var(--purple); }
        .hdr-serr { background: var(--orange); color: #000; }
        .grid-est { display: flex; flex-direction: column; gap: 12px; min-height: 50px; }

        /* ==========================================================================
           4. CARDS DOS PRODUTOS
           ========================================================================== */
        .card-prod { background: var(--card-bg); border-radius: 10px; padding: 15px; position: relative; border-left: 5px solid #555; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .card-prod.low-stock { border-right: 4px solid var(--red-cancel); }
        .btn-del-card { position: absolute; top: 10px; right: 10px; background: none; border: none; color: #555; font-size: 18px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-del-card:hover { color: var(--red-cancel); }
        
        .prod-cat { background: rgba(255,255,255,0.1); padding: 2px 8px; border-radius: 4px; font-size: 10px; color: #ccc; margin-bottom: 8px; display: inline-block; }
        .prod-name { font-size: 18px; font-weight: 800; color: white; margin-bottom: 5px; line-height: 1.1; }
        .prod-dims { font-size: 14px; color: var(--orange); font-weight: bold; margin-bottom: 5px; display: block; }
        .prod-details { font-size: 11px; color: var(--text-gray); display: block; margin-bottom: 10px;}
        .badge-status { font-size: 10px; padding: 3px 8px; border-radius: 4px; font-weight: bold; text-transform: uppercase; }

        .btn-adj { background: #333; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; font-family: inherit; transition: 0.2s;}
        .btn-adj:hover { background: var(--blue-used); }

        .fab-add { position: fixed; bottom: 20px; right: 20px; width: 65px; height: 65px; background: var(--orange); color: white; border-radius: 50%; border: none; font-size: 35px; font-weight: bold; box-shadow: 0 4px 15px rgba(255, 107, 0, 0.5); cursor: pointer; z-index: 100; transition: transform 0.2s; display: flex; align-items: center; justify-content: center;}
        .fab-add:hover { transform: scale(1.1); }

        /* ==========================================================================
           5. ESTILOS DOS MODAIS E INPUTS
           ========================================================================== */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal-box { background: var(--card-bg); width: 95%; max-width: 500px; max-height: 90vh; padding: 25px; border-radius: 16px; border: 1px solid #333; box-shadow: 0 20px 40px rgba(0,0,0,0.6); overflow-y: auto; position: relative; }
        
        .btn-voltar-top { position: absolute; top: 20px; right: 20px; background: transparent; color: var(--red-cancel); border: 1px solid var(--red-cancel); padding: 5px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 14px; transition: all 0.2s; z-index: 10; }
        .btn-voltar-top:hover { background: rgba(255, 59, 59, 0.1); }
        
        /* Padding-right adicionado para o bot√£o NOVO n√£o bater no Cancelar */
        .header-row { display: flex; align-items: center; gap: 15px; margin-bottom: 25px; padding-right: 90px; }
        .title-material { font-size: 30px; font-weight: 900; margin: 0; color: #fff; line-height: 1; }
        .btn-status-toggle { padding: 6px 12px; border-radius: 6px; border: none; font-weight: bold; font-size: 12px; cursor: pointer; text-transform: uppercase; transition: all 0.3s ease; }
        .status-novo { background-color: var(--green-new); color: white; }
        .status-usado { background-color: var(--blue-used); color: white; }

        .label-standard { display: block; font-size: 13px; color: var(--orange); font-weight: bold; }
        .sub-label-right { display: block; font-size: 12px; color: var(--text-gray); margin-bottom: 4px; text-align: right; width: 100%; }
        .btn-icon-action { background: #222; color: var(--orange); border: 1px solid #444; width: 32px; height: 32px; border-radius: 6px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; font-weight: bold;}
        
        input, select, textarea { width: 100%; padding: 12px; background: var(--input-bg); border: 1px solid #333; border-radius: 8px; color: white; outline: none; font-size: 14px; font-family: inherit; box-sizing: border-box;}
        textarea { resize: vertical; min-height: 100px; }
        
        .input-suffix-wrapper { position: relative; display: flex; align-items: center; }
        .input-suffix-wrapper::after { content: "cm"; position: absolute; right: 12px; color: var(--text-gray); font-size: 12px; pointer-events: none; }
        
        .form-row { display: flex; gap: 12px; margin-bottom: 15px; width: 100%;}
        .align-bottom { align-items: flex-end; }
        .field-group { flex: 1; min-width: 0; }
        .btn-salvar { width: 100%; background: var(--orange); color: white; border: none; padding: 16px; border-radius: 8px; font-weight: 900; margin-top: 20px; cursor: pointer; font-size: 16px; text-transform: uppercase; font-family: inherit;}
        .icon-refresh { width: 18px; height: 18px; fill: none; stroke: currentColor; stroke-width: 2.5; }

        /* ==========================================================================
           6. REFER√äNCIA VISUAL DE CORTE (QUADRADO LARANJA)
           ========================================================================== */
        #div-visual-corte { margin-top: 15px; padding: 20px; background: #000; border-radius: 8px; border: 1px solid #333; display: none; flex-direction: column; align-items: center; }
        .canvas-title { font-size: 10px; color: var(--orange); text-transform: uppercase; font-weight: bold; margin-bottom: 40px; letter-spacing: 1px; text-align: center; width: 100%; }
        .chapa-container { width: 100%; height: 180px; background: #080808; position: relative; border-radius: 4px; display: flex; align-items: center; justify-content: center; }
        #corte-wrapper { position: relative; display: flex; align-items: center; justify-content: center; }
        #corte-fill { background: var(--orange); border: 1px solid var(--white); transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; font-size: 11px; color: white; font-weight: bold; text-align: center; padding: 5px; }
        
        .cota-label { position: absolute; color: var(--orange); font-size: 11px; font-weight: bold; white-space: nowrap; }
        .cota-w-box { position: absolute; top: -35px; left: 0; width: 100%; display: flex; flex-direction: column; align-items: center; }
        .linha-cota-w { height: 1px; background-color: var(--orange); width: 100%; margin-top: 2px; position: relative; }
        .linha-cota-w::before, .linha-cota-w::after { content: ''; position: absolute; top: -4px; width: 1px; height: 9px; background-color: var(--orange); }
        .linha-cota-w::before { left: 0; } .linha-cota-w::after { right: 0; }
        
        .cota-h-box { position: absolute; left: -55px; top: 0; height: 100%; display: flex; flex-direction: row; align-items: center; }
        .linha-cota-h { width: 1px; background-color: var(--orange); height: 100%; margin-right: 5px; position: relative; }
        .linha-cota-h::before, .linha-cota-h::after { content: ''; position: absolute; left: -4px; width: 9px; height: 1px; background-color: var(--orange); }
        .linha-cota-h::before { top: 0; } .linha-cota-h::after { bottom: 0; }
    </style>
</head>
<body>

    <div id="sector-screen">
        <button class="sector-btn sec-imp" onclick="selecionarSetor('impressao')">
            <div class="sec-icon">üñ®Ô∏è</div>
            <div class="sec-title">Sala de Impress√£o</div>
            <span style="font-size:12px; margin-top:5px; opacity:0.8;">Adesivo, Lona, Recorte</span>
        </button>
        <button class="sector-btn sec-serr" onclick="selecionarSetor('serralheria')">
            <div class="sec-icon">üõ†Ô∏è</div>
            <div class="sec-title">Serralheria</div>
            <span style="font-size:12px; margin-top:5px; opacity:0.8;">Chapas e Retalhos</span>
        </button>
    </div>

    <div id="main-layout">
        <div class="header-est">
            <div>
                <h1 id="page-title">Estoque</h1>
            </div>
            <button class="btn-voltar" onclick="location.reload()">üîÑ TROCAR SETOR</button>
        </div>

        <div id="kanban-impressao" class="kanban-container" style="display: none;">
            <div class="kanban-col"><div class="kanban-header hdr-imp">Adesivos</div><div class="grid-est" id="grid-ADESIVO"></div></div>
            <div class="kanban-col"><div class="kanban-header hdr-imp">Lonas</div><div class="grid-est" id="grid-LONA"></div></div>
            <div class="kanban-col"><div class="kanban-header hdr-imp">Adesivos de Recorte</div><div class="grid-est" id="grid-RECORTE"></div></div>
            <div class="kanban-col"><div class="kanban-header" style="background:#444">Outros</div><div class="grid-est" id="grid-OUTROS-IMP"></div></div>
        </div>

        <div id="kanban-serralheria" class="kanban-container" style="display: none;">
            <div class="kanban-col"><div class="kanban-header hdr-serr">ACM</div><div class="grid-est" id="grid-ACM"></div></div>
            <div class="kanban-col"><div class="kanban-header hdr-serr">PVC</div><div class="grid-est" id="grid-PVC"></div></div>
            <div class="kanban-col"><div class="kanban-header hdr-serr">Acr√≠lico</div><div class="grid-est" id="grid-ACRILICO"></div></div>
            <div class="kanban-col"><div class="kanban-header" style="background:#444">Outros Metais/MDF</div><div class="grid-est" id="grid-OUTROS-SERR"></div></div>
        </div>

        <button class="fab-add" onclick="abrirModalProd()">+</button>
    </div>

    <!-- Modais de Interface (Omitidos os filhos por brevidade da estrutura HTML) -->
    <div id="modal-prod" class="modal-overlay">...</div>
    <div id="modal-mov" class="modal-overlay">...</div>
    <div id="modal-corte" class="modal-overlay">...</div>
    <div id="modal-detalhes" class="modal-overlay">...</div>

    <script type="module">
        import { db, ROTAS } from "./config.js";
        import { collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, where, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // ==========================================================================
        // SESS√ÉO 1: VARI√ÅVEIS GLOBAIS E CONFIGURA√á√ïES
        // ==========================================================================
        window.setorAtual = '';
        window.materialStatus = "Novo";
        window.isNewCategory = false;
        window.indiceMedidaPadrao = 0;
        let produtos = [];

        // Arrays din√¢micos que v√£o aprender com o banco de dados
        let categoriasDinamicas = [];
        let coresDinamicas = [];

        const CONFIG_FABRICA = {
            'acm': { medidas: [{w: 122, h: 500}, {w: 152, h: 500}], espessuras: ['3mm', '4mm'] },
            'pvc': { medidas: [{w: 122, h: 244}], espessuras: ['5mm', '10mm', '20mm'] },
            'ps': { medidas: [{w: 100, h: 200}, {w: 120, h: 240}], espessuras: ['1mm', '2mm','3mm','4mm','5mm','6mm','8mm','10mm'] },
            'acrilico': { medidas: [{w: 100, h: 200}, {w: 120, h: 240}], espessuras: ['2mm','3mm','4mm','5mm','6mm','8mm','10mm'] },
            'mdf': { medidas: [{w: 183, h: 275}], espessuras: ['3mm', '6mm', '15mm', '18mm'] },
            'galvanizada': { medidas: [{w: 120, h: 200}, {w: 120, h: 300}], espessuras: ['#28', '#26', '#24','#22','#20'] },
            'policarbonato': { medidas: [{w: 105, h: 600}, {w: 210, h: 600}], espessuras: ['4mm', '6mm', '10mm'] }
        };

        const CATS_IMP = ['Adesivo', 'Lona', 'Adesivo de Recorte', 'Tinta', 'Outros'];
        const CATS_SERR = ['ACM', 'PVC', 'PS', 'Acrilico', 'MDF', 'Galvanizada', 'Policarbonato'];
        const CORES_BASE = ['Preto', 'Branco', 'Transparente', 'Amarelo', 'Vermelho'];

        // ==========================================================================
        // SESS√ÉO 2: FUN√á√ïES DE NAVEGA√á√ÉO E CONSULTA AO BANCO (FIREBASE)
        // ==========================================================================

        /**
         * FUN√á√ÉO: selecionarSetor
         * Descri√ß√£o: Respons√°vel por fazer a transi√ß√£o da tela inicial de escolha 
         * para o painel principal (Kanban) do setor selecionado.
         * O que faz:
         * 1. Salva o setor escolhido ('impressao' ou 'serralheria') na vari√°vel global.
         * 2. Oculta a tela de sele√ß√£o inicial.
         * 3. Mostra o layout principal e altera o t√≠tulo e as cores do topo.
         * 4. Exibe o Kanban (colunas) correspondente ao setor.
         * 5. Chama a fun√ß√£o ouvirEstoque() para carregar os dados.
         * @param {string} setor - String indicando o setor ("impressao" ou "serralheria").
         */
        window.selecionarSetor = (setor) => {
            window.setorAtual = setor;
            
            // Controle de visualiza√ß√£o das telas (Esconde menu inicial, mostra painel)
            document.getElementById('sector-screen').style.display = 'none';
            document.getElementById('main-layout').style.display = 'block';
            
            // Define o estilo visual baseado no setor
            const isSerr = setor === 'serralheria';
            document.getElementById('page-title').innerText = isSerr ? 'Estoque Serralheria' : 'Sala de Impress√£o';
            document.getElementById('page-title').style.color = isSerr ? 'var(--orange)' : 'var(--purple)';
            
            // Alterna a visualiza√ß√£o das colunas Kanban
            document.getElementById('kanban-impressao').style.display = isSerr ? 'none' : 'flex';
            document.getElementById('kanban-serralheria').style.display = isSerr ? 'flex' : 'none';

            // Dispara a busca em tempo real do estoque
            ouvirEstoque();
        };

        /**
         * FUN√á√ÉO: ouvirEstoque
         * Descri√ß√£o: Cria um "ouvinte" em tempo real no banco de dados Firebase Firestore.
         * O que faz:
         * 1. Cria uma query buscando apenas os materiais do setor atual.
         * 2. Usa onSnapshot (escuta em tempo real) para que qualquer mudan√ßa no banco
         * atualize a tela instantaneamente sem precisar recarregar.
         * 3. Extrai categorias e cores cadastradas para alimentar listas din√¢micas.
         * 4. Chama a renderizarCards() para desenhar os itens na tela.
         */
        function ouvirEstoque() {
            // Filtra no banco a cole√ß√£o 'estoque' pelo setor selecionado
            const q = query(collection(db, "estoque"), where("setor", "==", window.setorAtual));
            
            // O snapshot √© disparado toda vez que h√° uma altera√ß√£o (cria√ß√£o, edi√ß√£o, exclus√£o)
            onSnapshot(q, (snapshot) => {
                produtos = [];
                // Preenche o array global com os documentos retornados
                snapshot.forEach(d => { 
                    let item = d.data(); 
                    item.id = d.id; 
                    produtos.push(item); 
                });
                
                // Extrai valores √∫nicos do banco para alimentar os selects automaticamente!
                // O 'Set' garante que n√£o haver√° valores duplicados nas categorias e cores.
                categoriasDinamicas = [...new Set(produtos.map(p => p.categoria).filter(Boolean))];
                coresDinamicas = [...new Set(produtos.map(p => p.cor).filter(Boolean))];
                
                // Desenha/Atualiza a interface
                renderizarCards();
            });
        }

        // ==========================================================================
        // SESS√ÉO 3: FUN√á√ïES DE RENDERIZA√á√ÉO DE INTERFACE (DOM)
        // ==========================================================================

        /**
         * FUN√á√ÉO: renderizarCards
         * Descri√ß√£o: Respons√°vel por gerar o HTML dos cards de produtos e 
         * inseri-los nas colunas corretas do Kanban.
         * O que faz:
         * 1. Limpa todas as colunas Kanban existentes na tela para evitar duplica√ß√£o.
         * 2. Percorre o array global de produtos.
         * 3. Trata e normaliza o nome da categoria para descobrir em qual coluna o card deve entrar.
         * 4. Constr√≥i o HTML do card customizando os dados exibidos (Chapa vs Impress√£o).
         * 5. Anexa o card gerado na respectiva div (coluna) do DOM.
         */
        function renderizarCards() {
            // 1. Limpa o HTML atual das colunas
            document.querySelectorAll('.grid-est').forEach(g => g.innerHTML = '');
            const isSerr = window.setorAtual === 'serralheria';

            // 2. Itera sobre cada produto carregado do banco
            produtos.forEach(p => {
                // 3. Limpeza do texto para comparar com o ID da coluna (Ex: "Acr√≠lico" -> "ACRILICO")
                let catLimpa = p.categoria.toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace("ADESIVO DE RECORTE", "RECORTE");
                
                // Verifica se a coluna espec√≠fica existe, caso contr√°rio joga para a coluna "OUTROS"
                let gridID = document.getElementById(`grid-${catLimpa}`) ? catLimpa : (isSerr ? 'OUTROS-SERR' : 'OUTROS-IMP');
                const grid = document.getElementById(`grid-${gridID}`);

                if(grid) {
                    // 4. Cria√ß√£o din√¢mica do Card
                    const card = document.createElement('div');
                    card.className = `card-prod`;
                    card.style.borderLeftColor = isSerr ? 'var(--orange)' : 'var(--purple)';

                    // Adiciona um selo visual (Badge) caso o material tenha anota√ß√µes/hist√≥rico
                    let temNotaBadge = p.anotacoes ? `<span style="position:absolute; top:10px; right:35px; background:var(--purple); color:white; font-size:10px; padding:2px 5px; border-radius:4px; font-weight:bold;">üìù Nota</span>` : '';

                    // In√≠cio do HTML do card com bot√£o de apagar
                    let conteudo = temNotaBadge + `<button class="btn-del-card" onclick="deletarItem('${p.id}')">√ó</button>`;
                    conteudo += `<span class="prod-cat">${p.categoria}</span>`;
                    
                    // Estrutura√ß√£o condicional: Serralheria (Dimens√µes/Cortes) vs Impress√£o (Qtd/Rolos)
                    if (isSerr) {
                        conteudo += `<div class="prod-name">${p.categoria} ${p.espessura || ''}</div>`;
                        conteudo += `<span class="prod-dims">${p.dimW} x ${p.dimH} cm</span>`;
                        conteudo += `<span class="prod-details">Cor: ${p.cor || 'N/A'} ${p.acabamento ? '| ' + p.acabamento : ''}</span>`;
                        
                        const bgStatus = p.status === 'Novo' ? 'var(--green-new)' : 'var(--blue-used)';
                        conteudo += `<span class="badge-status" style="background:${bgStatus}; color:white">${p.status}</span>`;
                        
                        // Bot√µes de a√ß√£o para serralheria (Corte de chapas / Visualizar Hist√≥rico)
                        conteudo += `
                            <div style="display:flex; gap:10px; margin-top:10px;">
                                <button class="btn-adj" style="flex:1; border:1px solid #444;" onclick="abrirModalCorte('${p.id}')">‚úÇÔ∏è CORTAR</button>
                                <button class="btn-adj" style="flex:1; background:#222; border:1px solid #444;" onclick="abrirModalDetalhes('${p.id}')">üìã INFO</button>
                            </div>
                        `;
                    } else {
                        // Layout de cards para o setor de impress√£o
                        conteudo += `<div class="prod-name">${p.nome || p.categoria}</div>`;
                        // C√ìDIGO COMPLETADO E CORRIGIDO:
                        conteudo += `
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-top:15px; background:#222; padding:10px; border-radius:8px;">
                                <div><b style="font-size:24px;">${p.qtd}</b> <small style="color:#aaa">${p.unidade}</small></div>
                            </div>
                        `;
                    }

                    // 5. Aplica o HTML no card e o card na coluna do Kanban
                    card.innerHTML = conteudo;
                    grid.appendChild(card);
                }
            });
        }
    </script>
</body>
</html>
