<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visita T√©cnica - Artesynal</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #1a1a1a; --card: #222; --yellow: #f1c40f; --blue: #00aeef; --green: #2ecc71; --red: #e74c3c; --text: #eee; --input: #333; }
        body { font-family: 'Mitra LT', 'Montserrat', sans-serif; background: var(--bg); color: var(--text); padding: 15px; margin: 0; padding-bottom: 100px; }
        
        .vt-card { background: var(--card); border-radius: 15px; border-top: 5px solid var(--yellow); padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); margin-bottom: 20px; }
        .label { color: var(--yellow); font-size: 10px; font-weight: bold; text-transform: uppercase; margin-bottom: 3px; display: block; }
        .value { font-size: 16px; margin-bottom: 15px; font-weight: 600; }
        .info-box { background: #111; padding: 12px; border-radius: 8px; border-left: 4px solid var(--yellow); white-space: pre-wrap; font-size: 14px; color: #ccc; }

        /* GALERIA IGUAL SOLICITACAO.HTML */
        .gallery-container { margin-top: 20px; }
        .gallery-controls { display: flex; gap: 10px; margin-bottom: 15px; }
        .btn-photo { flex: 1; padding: 12px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; color: white; font-family: inherit; font-size: 12px; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-upload { background: #444; }
        .btn-cam { background: var(--blue); }
        
        .photo-viewer { background: #000; height: 300px; display: flex; align-items: center; justify-content: center; position: relative; border-radius: 8px; overflow: hidden; margin-bottom: 10px; }
        .photo-viewer img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .photo-count { text-align: center; font-size: 12px; color: #888; margin-bottom: 10px; }
        
        .mini-gallery { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; }
        .thumb { min-width: 60px; height: 60px; border-radius: 5px; overflow: hidden; border: 2px solid transparent; opacity: 0.6; cursor: pointer; }
        .thumb.selected { border-color: var(--yellow); opacity: 1; }
        .thumb img { width: 100%; height: 100%; object-fit: cover; }

        /* EDITOR DE DESENHO */
        #draw-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 5000; flex-direction: column; }
        #canvas-wrapper { flex: 1; position: relative; display: flex; align-items: center; justify-content: center; touch-action: none; }
        canvas { max-width: 100%; max-height: 100%; }
        .draw-toolbar { height: 60px; background: #111; display: flex; justify-content: space-between; align-items: center; padding: 0 15px; border-top: 2px solid var(--yellow); }

        .btn-save-all { position: fixed; bottom: 20px; left: 20px; right: 20px; background: var(--green); color: white; border: none; padding: 18px; border-radius: 10px; font-weight: 900; font-size: 16px; cursor: pointer; box-shadow: 0 5px 20px rgba(0,0,0,0.5); z-index: 1000; }
        .btn-save-all:disabled { background: #444; opacity: 0.7; }

        .btn-nav { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.5); color: white; border: none; padding: 15px 10px; cursor: pointer; font-size: 20px; }
        .btn-prev { left: 0; border-radius: 0 5px 5px 0; }
        .btn-next { right: 0; border-radius: 5px 0 0 5px; }

        @media (max-width: 600px) { .photo-viewer { height: 220px; } }
    </style>
</head>
<body>

    <div id="draw-modal">
        <div id="canvas-wrapper"><canvas id="editor-canvas"></canvas></div>
        <div class="draw-toolbar">
            <button class="btn-photo" style="background:#444" onclick="window.fecharEditor()">CANCELAR</button>
            <button class="btn-photo" style="background:var(--green)" onclick="window.salvarEditor()">SALVAR MEDIDA</button>
        </div>
    </div>

    <div class="vt-card">
        <h2 style="margin-top:0; color:var(--yellow)">Visita T√©cnica</h2>
        <span class="label">Cliente</span>
        <div class="value" id="v-cliente">Carregando...</div>
        
        <span class="label">Endere√ßo</span>
        <div class="value" id="v-endereco">...</div>
        
        <span class="label">Informa√ß√µes da Visita</span>
        <div class="info-box" id="v-info">...</div>
    </div>

    <div class="gallery-container">
        <span class="label">Galeria de Fotos & Medidas</span>
        <div class="gallery-controls">
            <input type="file" id="file-input" accept="image/*" multiple style="display:none">
            <input type="file" id="cam-input" accept="image/*" capture="environment" style="display:none">
            <button class="btn-photo btn-upload" onclick="document.getElementById('file-input').click()">üìÅ ARQUIVO</button>
            <button class="btn-photo btn-cam" onclick="document.getElementById('cam-input').click()">üì∑ C√ÇMERA</button>
        </div>

        <div class="photo-viewer">
            <button class="btn-nav btn-prev" onclick="window.mudarFoto(-1)">‚ùÆ</button>
            <img id="main-img" src="">
            <button class="btn-nav btn-next" onclick="window.mudarFoto(1)">‚ùØ</button>
            <button onclick="window.abrirEditor()" style="position:absolute; bottom:10px; right:10px; background:var(--yellow); border:none; padding:8px 15px; border-radius:5px; font-weight:bold; cursor:pointer">üìè MEDIDAS</button>
        </div>
        <div class="photo-count" id="photo-count">0 / 0</div>
        
        <div class="mini-gallery" id="mini-gallery"></div>
        <input type="text" id="img-obs" placeholder="Nota sobre esta foto..." style="width:100%; padding:12px; background:#222; border:none; border-radius:5px; color:white; margin-top:10px;" oninput="window.saveLocalObs()">
    </div>

    <button id="btn-final-save" class="btn-save-all" onclick="window.sincronizarComOrcamento()">üíæ SALVAR E SINCRONIZAR</button>

    <script type="module">
        import { db } from "./config.js";
        import { doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const params = new URLSearchParams(window.location.search);
        const visitaId = params.get('id');
        
        let imagens = [];
        let indiceAtual = 0;
        let orcamentoId = null;

        // Canvas Vars
        let canvas = document.getElementById('editor-canvas');
        let ctx = canvas.getContext('2d');
        let isDrawing = false, startX, startY;

        window.onload = async () => {
            if (!visitaId) return;
            const vSnap = await getDoc(doc(db, "visitas", visitaId));
            
            if (vSnap.exists()) {
                const v = vSnap.data();
                orcamentoId = v.orcamento_id;
                document.getElementById('v-cliente').innerText = v.cliente;
                document.getElementById('v-endereco').innerText = v.endereco;
                document.getElementById('v-info').innerText = v.info_adicional || "Verificar local para instala√ß√£o.";

                // Busca fotos do or√ßamento original para o t√©cnico ver
                const oSnap = await getDoc(doc(db, "orcamentos", orcamentoId));
                if (oSnap.exists()) {
                    imagens = oSnap.data().imagens || [];
                    window.renderGallery();
                }
            }
            
            document.getElementById('file-input').onchange = window.addFotos;
            document.getElementById('cam-input').onchange = window.addFotos;
        };

        window.addFotos = (e) => {
            const files = e.target.files;
            for(let f of files) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    imagens.push({ url: ev.target.result, obs: "" });
                    indiceAtual = imagens.length - 1;
                    window.renderGallery();
                };
                reader.readAsDataURL(f);
            }
        };

        window.renderGallery = () => {
            const mini = document.getElementById('mini-gallery');
            mini.innerHTML = '';
            imagens.forEach((img, i) => {
                const div = document.createElement('div');
                div.className = `thumb ${i === indiceAtual ? 'selected' : ''}`;
                div.onclick = () => { indiceAtual = i; window.renderGallery(); };
                div.innerHTML = `<img src="${img.url}">`;
                mini.appendChild(div);
            });

            if (imagens[indiceAtual]) {
                document.getElementById('main-img').src = imagens[indiceAtual].url;
                document.getElementById('img-obs').value = imagens[indiceAtual].obs || "";
                document.getElementById('photo-count').innerText = `${indiceAtual + 1} / ${imagens.length}`;
            }
        };

        window.mudarFoto = (dir) => {
            if (imagens.length === 0) return;
            indiceAtual = (indiceAtual + dir + imagens.length) % imagens.length;
            window.renderGallery();
        };

        window.saveLocalObs = () => {
            if (imagens[indiceAtual]) imagens[indiceAtual].obs = document.getElementById('img-obs').value;
        };

        // EDITOR DE MEDIDAS (Igual ao solicitacao.html)
        window.abrirEditor = () => {
            if(!imagens[indiceAtual]) return;
            document.getElementById('draw-modal').style.display = 'flex';
            const img = new Image();
            img.onload = () => {
                canvas.width = img.width; canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
            };
            img.src = imagens[indiceAtual].url;
        };

        window.fecharEditor = () => document.getElementById('draw-modal').style.display = 'none';

        canvas.onmousedown = (e) => {
            isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            startX = (e.clientX - rect.left) * scaleX;
            startY = (e.clientY - rect.top) * scaleY;
        };

        canvas.onmouseup = (e) => {
            if(!isDrawing) return;
            isDrawing = false;
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const endX = (e.clientX - rect.left) * scaleX;
            const endY = (e.clientY - rect.top) * scaleY;
            
            const txt = prompt("Medida:");
            if(txt) {
                ctx.strokeStyle = "red"; ctx.lineWidth = Math.max(5, canvas.width/100);
                ctx.beginPath(); ctx.moveTo(startX, startY); ctx.lineTo(endX, endY); ctx.stroke();
                ctx.fillStyle = "red"; ctx.font = `bold ${Math.max(30, canvas.width/20)}px Montserrat`;
                ctx.fillText(txt, (startX + endX)/2, (startY + endY)/2 - 10);
            }
        };

        window.salvarEditor = () => {
            imagens[indiceAtual].url = canvas.toDataURL("image/jpeg", 0.7);
            window.renderGallery();
            window.fecharEditor();
        };

        // SINCRONIZA√á√ÉO TOTAL
        window.sincronizarComOrcamento = async () => {
            const btn = document.getElementById('btn-final-save');
            btn.disabled = true;
            btn.innerText = "SINCRONIZANDO...";

            try {
                // Atualiza o Or√ßamento Original com as novas fotos/medidas do t√©cnico
                await updateDoc(doc(db, "orcamentos", orcamentoId), {
                    imagens: imagens
                });

                // Opcional: Atualiza o status da visita
                await updateDoc(doc(db, "visitas", visitaId), {
                    status: "Conclu√≠da"
                });

                alert("Sincronizado com sucesso! O escrit√≥rio j√° pode ver as fotos.");
            } catch (e) {
                console.error(e);
                alert("Erro ao sincronizar.");
            } finally {
                btn.disabled = false;
                btn.innerText = "üíæ SALVAR E SINCRONIZAR";
            }
        };
    </script>
</body>
</html>
