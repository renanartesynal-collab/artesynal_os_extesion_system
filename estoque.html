<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estoque & Corte - Artesynal</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --bg-dark: #1a1a1a; --card-bg: #2c3e50; --purple: #9b59b6; --orange: #e67e22; --red: #e74c3c; --green: #2ecc71; --blue: #3498db; --text: #eee; }
        body { font-family: 'Montserrat', sans-serif; margin: 0; padding: 0; background-color: var(--bg-dark); color: var(--text); overflow-x: hidden; }

        /* --- TELA SELE√á√ÉO --- */
        #sector-screen { display: flex; height: 100vh; width: 100%; align-items: center; justify-content: center; gap: 30px; position: fixed; top: 0; left: 0; background: var(--bg-dark); z-index: 1000; flex-wrap: wrap; padding: 20px;}
        .sector-btn { width: 300px; height: 200px; border-radius: 15px; border: none; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; font-family: 'Montserrat'; transition: transform 0.2s; text-decoration: none; color: white;}
        .sector-btn:hover { transform: scale(1.05); }
        .sec-imp { background: linear-gradient(135deg, #8e44ad, #c0392b); box-shadow: 0 0 20px rgba(142, 68, 173, 0.5); }
        .sec-serr { background: linear-gradient(135deg, #e67e22, #f1c40f); box-shadow: 0 0 20px rgba(230, 126, 34, 0.5); color: #222; }
        .sec-icon { font-size: 50px; margin-bottom: 10px; }
        .sec-title { font-size: 24px; font-weight: 900; text-transform: uppercase; }

        /* --- LAYOUT PRINCIPAL --- */
        #main-layout { display: none; padding: 20px; transition: 0.3s; margin-right: 0; }
        .header-est { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #555; padding-bottom: 15px; }
        h1 { margin: 0; color: var(--purple); font-size: 24px; text-transform: uppercase; }
        .btn-voltar { cursor: pointer; color: white; background: #555; padding: 8px 15px; border-radius: 5px; font-size: 12px; font-weight: bold; border:none;}

        /* FILTROS E GRID */
        .filter-bar { display: flex; gap: 10px; margin-bottom: 20px; background: #333; padding: 10px; border-radius: 8px; flex-wrap: wrap;}
        .search-input, .cat-select { flex: 1; padding: 10px; border-radius: 5px; border: none; background: #444; color: white; min-width: 150px; }
        .grid-est { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }

        /* CARDS */
        .card-prod { background: var(--card-bg); border-radius: 10px; padding: 15px; position: relative; border-left: 5px solid var(--purple); box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .card-prod.serralheria { border-left-color: var(--orange); }
        .card-prod.low-stock { border: 2px solid var(--red); }

        .prod-header { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .prod-cat { background: rgba(0,0,0,0.3); padding: 2px 8px; border-radius: 4px; font-size: 10px; color: #ccc; }
        .prod-name { font-size: 18px; font-weight: 800; color: white; margin-bottom: 5px; }
        .prod-dims { font-size: 14px; color: var(--orange); font-weight: bold; margin-bottom: 10px; display: block; }

        .stock-control { background: #222; border-radius: 8px; padding: 10px; display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
        .stock-display { text-align: center; }
        .stock-val { font-size: 24px; font-weight: 900; }
        .stock-unit { font-size: 10px; color: #aaa; }
        .btn-mov { background: var(--blue); color: white; border: none; padding: 5px 15px; border-radius: 5px; font-weight: bold; cursor: pointer; font-size: 12px; }

        .btn-cut-action { 
            background: var(--orange); color: #222; width: 100%; border: none; padding: 12px; 
            border-radius: 5px; font-weight: 900; cursor: pointer; margin-bottom: 10px; 
            font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 10px;
            box-shadow: 0 4px 0 #d35400; transition: 0.1s;
        }
        .btn-cut-action:active { transform: translateY(4px); box-shadow: 0 0 0; }

        /* SIDEBAR LISTA DE CORTES */
        #sidebar-cuts { 
            position: fixed; top: 0; right: -350px; width: 320px; height: 100%; 
            background: #111; box-shadow: -5px 0 15px rgba(0,0,0,0.5); 
            z-index: 500; transition: 0.3s; padding: 20px; box-sizing: border-box; 
            display: flex; flex-direction: column; border-left: 2px solid var(--orange);
        }
        #sidebar-cuts.open { right: 0; }
        .cut-item { background: #222; padding: 10px; margin-bottom: 10px; border-radius: 5px; border-left: 3px solid var(--orange); display: flex; justify-content: space-between; align-items: center; }
        .btn-process { margin-top: auto; background: var(--green); color: white; border: none; padding: 15px; font-weight: 900; font-size: 16px; cursor: pointer; width: 100%; }

        /* MODAIS */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 600; justify-content: center; align-items: center; padding: 20px; }
        .modal-box { background: #333; padding: 25px; border-radius: 10px; width: 100%; max-width: 650px; position: relative; }
        .form-row { display: flex; gap: 10px; margin-bottom: 15px; }
        label { display: block; font-size: 11px; color: #ccc; margin-bottom: 5px; font-weight: bold; }
        input, select { width: 100%; padding: 12px; background: #444; border: none; border-radius: 5px; color: white; box-sizing: border-box; }

        /* =========================================
           NOVO EDITOR VISUAL (AREA DE CORTE)
           ========================================= */
        #editor-wrapper {
            width: 100%; height: 350px; background: #222; border: 1px solid #555;
            margin-bottom: 15px; display: flex; justify-content: center; align-items: center;
            overflow: hidden; position: relative;
            /* Grade de fundo para refer√™ncia */
            background-image: linear-gradient(#333 1px, transparent 1px), linear-gradient(90deg, #333 1px, transparent 1px);
            background-size: 20px 20px;
        }

        #plate-visual {
            background: white; /* Cor da Chapa Original */
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
            /* O tamanho ser√° definido via JS */
        }
        
        /* Label da Chapa Original */
        #plate-label {
            position: absolute; bottom: 5px; right: 5px; 
            color: #ccc; font-size: 10px; font-weight: bold; pointer-events: none;
        }

        /* Pe√ßa de Corte (Arrast√°vel) */
        #cut-rect {
            position: absolute; 
            top: 0; left: 0;
            border: 2px solid var(--red); /* Borda Vermelha T√©cnica */
            background: rgba(231, 76, 60, 0.15); /* Vermelho Transparente */
            cursor: move;
            box-sizing: border-box;
            touch-action: none; /* Vital para mobile */
            z-index: 10;
        }
        #cut-rect:active { background: rgba(231, 76, 60, 0.3); border-color: #fff; }

        /* LINHAS DE COTA (T√©cnicas) */
        .dim-line { position: absolute; background: var(--red); pointer-events: none; }
        .dim-text { position: absolute; color: var(--red); font-weight: bold; font-size: 16px; white-space: nowrap; pointer-events: none; text-shadow: 0 0 3px black; }

        /* Cota Superior (Largura) */
        .dim-top-h { height: 10px; border-left: 1px solid var(--red); border-right: 1px solid var(--red); position: absolute; top: -15px; width: 100%; left: 0; }
        .dim-top-text { top: -35px; width: 100%; text-align: center; left: 0; }

        /* Cota Lateral (Altura) */
        .dim-left-v { width: 10px; border-top: 1px solid var(--red); border-bottom: 1px solid var(--red); position: absolute; left: -15px; height: 100%; top: 0; }
        .dim-left-text { left: -60px; top: 50%; transform: translateY(-50%) rotate(-90deg); text-align: center; }


        .fab-add { position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; background: var(--green); color: white; border-radius: 50%; border: none; font-size: 30px; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.5); cursor: pointer; z-index: 100; }
        .fab-sidebar { position: fixed; bottom: 90px; right: 20px; width: 50px; height: 50px; background: var(--orange); color: #222; border-radius: 50%; border: none; font-size: 20px; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.5); cursor: pointer; z-index: 100; display: none; }
    </style>
</head>
<body>

    <div id="sector-screen">
        <button class="sector-btn sec-imp" onclick="selecionarSetor('impressao')">
            <div class="sec-icon">üñ®Ô∏è</div>
            <div class="sec-title">Sala de Impress√£o</div>
            <span style="font-size:10px; color:white;">Lonas, Tintas, Rolos</span>
        </button>
        <button class="sector-btn sec-serr" onclick="selecionarSetor('serralheria')">
            <div class="sec-icon">üõ†Ô∏è</div>
            <div class="sec-title">Serralheria</div>
            <span style="font-size:10px; color:black;">Chapas, Cortes, Pe√ßas</span>
        </button>
        <div style="width:100%; text-align:center;"><a href="painel.html" style="color:#666; text-decoration:none;">Voltar</a></div>
    </div>

    <div id="main-layout">
        <div class="header-est">
            <h1 id="page-title">Estoque</h1>
            <button class="btn-voltar" onclick="location.reload()">üîÑ SETOR</button>
        </div>

        <div class="filter-bar">
            <input type="text" id="search-input" class="search-input" placeholder="Buscar material..." onkeyup="filtrarEstoque()">
            <select id="cat-filter" class="cat-select" onchange="filtrarEstoque()">
                <option value="Todos">Todas Categorias</option>
            </select>
        </div>

        <div class="grid-est" id="grid-estoque"></div>
        
        <button class="fab-add" onclick="abrirModalProduto()">+</button>
        <button class="fab-sidebar" id="btn-sidebar-toggle" onclick="toggleSidebar()">‚úÇÔ∏è</button>
    </div>

    <div id="sidebar-cuts">
        <h3 style="color:var(--orange); margin-top:0;">Lista de Corte</h3>
        <div id="cuts-list" style="flex:1; overflow-y:auto; color:#888; font-size:12px;">Nenhum corte adicionado.</div>
        <button class="btn-process" onclick="finalizarCortes()">‚úÖ FINALIZAR & BAIXAR</button>
    </div>

    <div id="modal-mov" class="modal-overlay">
        <div class="modal-box">
            <h2 style="margin-top:0;">Ajustar Estoque</h2>
            <input type="hidden" id="mov-id">
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <button class="btn-mov" style="flex:1; background:var(--green);" onclick="salvarMov('entrada')">ENTRADA (+)</button>
                <button class="btn-mov" style="flex:1; background:var(--red);" onclick="salvarMov('saida')">BAIXA (-)</button>
            </div>
            <input type="number" id="mov-qtd" placeholder="Quantidade">
            <button class="btn-mov" style="width:100%; margin-top:10px; background:#555;" onclick="fecharModal('modal-mov')">Cancelar</button>
        </div>
    </div>

    <div id="modal-corte" class="modal-overlay">
        <div class="modal-box">
            <h2 style="margin-top:0; color:var(--orange);">Cortar Pe√ßa</h2>
            <div style="font-size:12px; color:#aaa; margin-bottom:10px;">
                Material Base: <span id="cut-info" style="color:white; font-weight:bold;">--</span>
            </div>

            <input type="hidden" id="cut-prod-id">
            <input type="hidden" id="orig-w">
            <input type="hidden" id="orig-h">

            <div id="editor-wrapper">
                <div id="plate-visual">
                    <div id="plate-label">CHAPA ORIGINAL</div>
                    </div>
            </div>

            <div class="form-row">
                <div style="flex:1;">
                    <label>LARGURA CORTE (cm)</label>
                    <input type="number" id="cut-w" placeholder="Largura" oninput="atualizarCorteVisual()">
                </div>
                <div style="flex:1;">
                    <label>ALTURA CORTE (cm)</label>
                    <input type="number" id="cut-h" placeholder="Altura" oninput="atualizarCorteVisual()">
                </div>
            </div>

            <div style="font-size:11px; color:#aaa; text-align:center; margin-bottom:15px;">
                Arraste o quadrado vermelho para posicionar o corte na chapa.
            </div>

            <div style="display:flex; gap:10px;">
                <button class="btn-mov" style="flex:1; background:#555;" onclick="fecharModal('modal-corte')">CANCELAR</button>
                <button class="btn-mov" style="flex:1; background:var(--orange); color:#222;" onclick="adicionarCorte()">ADICIONAR √Ä LISTA</button>
            </div>
        </div>
    </div>

    <div id="modal-prod" class="modal-overlay">
        <div class="modal-box">
            <h2 id="modal-title">Novo Material</h2>
            <input type="hidden" id="prod-id">
            <label>NOME DO MATERIAL</label>
            <input type="text" id="prod-nome" style="margin-bottom:15px;">
            
            <div class="form-row">
                <div style="flex:1;">
                    <label>CATEGORIA</label>
                    <select id="prod-cat"></select>
                </div>
                <div style="flex:1;" id="div-un">
                    <label>UNIDADE</label>
                    <select id="prod-un">
                        <option value="un">Unidade</option>
                        <option value="m">Metros</option>
                        <option value="m¬≤">m¬≤</option>
                        <option value="L">Litros</option>
                    </select>
                </div>
            </div>

            <div id="div-dims" style="display:none; background:#222; padding:10px; border-radius:5px; margin-bottom:15px;">
                <label style="color:var(--orange);">DIMENS√ïES DA PE√áA (cm)</label>
                <div class="form-row">
                    <input type="number" id="prod-dim-w" placeholder="Largura">
                    <input type="number" id="prod-dim-h" placeholder="Altura">
                </div>
            </div>

            <div id="div-qtd" style="display:block;">
                <div class="form-row">
                    <div style="flex:1;"><label>QTD ATUAL</label><input type="number" id="prod-qtd"></div>
                    <div style="flex:1;"><label>M√çNIMO</label><input type="number" id="prod-min"></div>
                </div>
            </div>

            <button class="btn-mov" style="width:100%; background:var(--green); margin-top:10px;" onclick="salvarProduto()">SALVAR</button>
            <button class="btn-mov" style="width:100%; background:#555; margin-top:5px;" onclick="fecharModal('modal-prod')">CANCELAR</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, where } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBxG9GNxfJxWiw8hpreTeShrG009svRmPI",
            authDomain: "artesynal-os-system.firebaseapp.com",
            projectId: "artesynal-os-system",
            storageBucket: "artesynal-os-system.firebasestorage.app",
            messagingSenderId: "539958005846",
            appId: "1:539958005846:web:9120505e097b56bf16ebf7"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let setorAtual = '';
        let produtos = [];
        let cortes = [];
        let scaleFactor = 1; // Fator de convers√£o CM -> Pixel

        const config = {
            'impressao': { color: 'var(--purple)', cats: ['Lona','Adesivo','Tinta','Outros'], isSerr: false },
            'serralheria': { color: 'var(--orange)', cats: ['ACM','PVC','Acr√≠lico','Metal','Madeira'], isSerr: true }
        };

        // --- NAVEGA√á√ÉO ---
        window.selecionarSetor = (setor) => {
            setorAtual = setor;
            document.getElementById('sector-screen').style.display = 'none';
            document.getElementById('main-layout').style.display = 'block';
            document.getElementById('page-title').innerText = setor === 'impressao' ? 'Impress√£o' : 'Serralheria';
            document.getElementById('page-title').style.color = config[setor].color;
            document.getElementById('btn-sidebar-toggle').style.display = config[setor].isSerr ? 'flex' : 'none';

            const sel = document.getElementById('cat-filter');
            const selModal = document.getElementById('prod-cat');
            sel.innerHTML = '<option value="Todos">Todas</option>';
            selModal.innerHTML = '';
            config[setor].cats.forEach(c => {
                sel.innerHTML += `<option value="${c}">${c}</option>`;
                selModal.innerHTML += `<option value="${c}">${c}</option>`;
            });

            carregarEstoque();
        };

        window.toggleSidebar = () => {
            document.getElementById('sidebar-cuts').classList.toggle('open');
            const layout = document.getElementById('main-layout');
            layout.style.marginRight = layout.style.marginRight === '320px' ? '0' : '320px';
        };

        // --- FIREBASE READ ---
        async function carregarEstoque() {
            const grid = document.getElementById('grid-estoque');
            grid.innerHTML = '<div style="color:#aaa; text-align:center;">Carregando...</div>';
            try {
                const q = query(collection(db, "estoque"), where("setor", "==", setorAtual));
                const snap = await getDocs(q);
                produtos = [];
                snap.forEach(d => { let i = d.data(); i.id = d.id; produtos.push(i); });
                renderizar();
            } catch(e) { console.error(e); }
        }

        function renderizar() {
            const grid = document.getElementById('grid-estoque');
            grid.innerHTML = '';
            const isSerr = config[setorAtual].isSerr;

            if(produtos.length === 0) { grid.innerHTML = '<div>Sem itens.</div>'; return; }

            produtos.forEach(p => {
                let cardHTML = '';
                if (isSerr) {
                    cardHTML = `
                        <div class="card-prod serralheria">
                            <div class="prod-header">
                                <span class="prod-cat">${p.categoria}</span>
                                <button onclick="deletar('${p.id}')" style="background:none; border:none; color:#555;">üóëÔ∏è</button>
                            </div>
                            <div class="prod-name">${p.nome}</div>
                            <span class="prod-dims">${p.dimW} x ${p.dimH} cm</span>
                            <button class="btn-cut-action" onclick="abrirCorte('${p.id}')">‚úÇÔ∏è CORTAR PE√áA</button>
                        </div>
                    `;
                } else {
                    const isLow = p.qtd <= p.minimo;
                    cardHTML = `
                        <div class="card-prod ${isLow ? 'low-stock' : ''}">
                            <div class="prod-header"><span class="prod-cat">${p.categoria}</span></div>
                            <div class="prod-name">${p.nome}</div>
                            <div class="stock-control">
                                <div class="stock-display">
                                    <div class="stock-val">${p.qtd}</div>
                                    <div class="stock-unit">${p.unidade}</div>
                                </div>
                                <button class="btn-mov" onclick="abrirMov('${p.id}')">AJUSTAR</button>
                            </div>
                        </div>
                    `;
                }
                grid.innerHTML += cardHTML;
            });
        }

        window.filtrarEstoque = () => { /* Implementar se necess√°rio */ };

        // --- L√ìGICA DO EDITOR DE CORTE (CORRIGIDA E REFEITA) ---
        window.abrirCorte = (id) => {
            const p = produtos.find(x => x.id === id);
            
            // Dados ocultos
            document.getElementById('cut-prod-id').value = id;
            document.getElementById('orig-w').value = p.dimW;
            document.getElementById('orig-h').value = p.dimH;
            
            // UI
            document.getElementById('cut-info').innerText = `${p.nome} (${p.dimW}x${p.dimH} cm)`;
            document.getElementById('cut-w').value = '';
            document.getElementById('cut-h').value = '';

            // Configurar o Canvas (Chapa Original)
            const wrapper = document.getElementById('editor-wrapper');
            const plate = document.getElementById('plate-visual');
            plate.innerHTML = '<div id="plate-label">CHAPA ORIGINAL</div>'; // Limpa e p√µe label

            // C√ÅLCULO DE ESCALA (Para caber na tela mantendo propor√ß√£o)
            // wrapper tem 350px altura e ~600px largura
            const maxW = wrapper.clientWidth - 40;
            const maxH = wrapper.clientHeight - 40;
            
            const ratioW = maxW / p.dimW;
            const ratioH = maxH / p.dimH;
            scaleFactor = Math.min(ratioW, ratioH); // Usa a menor escala para caber tudo

            // Aplica tamanho visual na chapa branca
            plate.style.width = (p.dimW * scaleFactor) + 'px';
            plate.style.height = (p.dimH * scaleFactor) + 'px';

            document.getElementById('modal-corte').style.display = 'flex';
        };

        window.atualizarCorteVisual = () => {
            const plate = document.getElementById('plate-visual');
            
            // Remove corte anterior se houver
            const oldCut = document.getElementById('cut-rect');
            if(oldCut) oldCut.remove();

            const cutW = parseFloat(document.getElementById('cut-w').value);
            const cutH = parseFloat(document.getElementById('cut-h').value);
            const origW = parseFloat(document.getElementById('orig-w').value);
            const origH = parseFloat(document.getElementById('orig-h').value);

            if(!cutW || !cutH) return;
            if(cutW > origW || cutH > origH) { 
                // Alerta visual simples
                return; 
            }

            // Cria o elemento de corte
            const piece = document.createElement('div');
            piece.id = 'cut-rect';
            piece.style.width = (cutW * scaleFactor) + 'px';
            piece.style.height = (cutH * scaleFactor) + 'px';
            
            // INJETA AS LINHAS DE COTA T√âCNICAS
            piece.innerHTML = `
                <div class="dim-top-h"></div>
                <div class="dim-text dim-top-text">${cutW}cm</div>
                <div class="dim-left-v"></div>
                <div class="dim-text dim-left-text">${cutH}cm</div>
            `;

            plate.appendChild(piece);

            // ATIVA O DRAG (ARRASTAR)
            iniciarArrasto(piece, plate);
        };

        // FUN√á√ÉO DE ARRASTAR CORRIGIDA (Usa eventos na Window para n√£o travar)
        function iniciarArrasto(elemento, container) {
            let posInicialX = 0, posInicialY = 0, posMouseX = 0, posMouseY = 0;

            elemento.onmousedown = dragMouseDown;
            elemento.ontouchstart = dragMouseDown;

            function dragMouseDown(e) {
                e = e || window.event;
                e.preventDefault();
                
                // Pega posi√ß√£o inicial do mouse
                if (e.type === 'touchstart') {
                    posMouseX = e.touches[0].clientX;
                    posMouseY = e.touches[0].clientY;
                } else {
                    posMouseX = e.clientX;
                    posMouseY = e.clientY;
                }

                // Liga os eventos de movimento na JANELA (n√£o no elemento)
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
                document.ontouchend = closeDragElement;
                document.ontouchmove = elementDrag;
            }

            function elementDrag(e) {
                e = e || window.event;
                
                let clientX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX;
                let clientY = e.type === 'touchmove' ? e.touches[0].clientY : e.clientY;

                // Calcula deslocamento
                posInicialX = posMouseX - clientX;
                posInicialY = posMouseY - clientY;
                posMouseX = clientX;
                posMouseY = clientY;

                // Calcula nova posi√ß√£o (Top/Left)
                let newTop = (elemento.offsetTop - posInicialY);
                let newLeft = (elemento.offsetLeft - posInicialX);

                // Limites (Colis√£o com a borda da chapa)
                let maxTop = container.clientHeight - elemento.clientHeight;
                let maxLeft = container.clientWidth - elemento.clientWidth;

                if (newTop < 0) newTop = 0;
                if (newLeft < 0) newLeft = 0;
                if (newTop > maxTop) newTop = maxTop;
                if (newLeft > maxLeft) newLeft = maxLeft;

                // Aplica
                elemento.style.top = newTop + "px";
                elemento.style.left = newLeft + "px";
            }

            function closeDragElement() {
                // Desliga eventos
                document.onmouseup = null;
                document.onmousemove = null;
                document.ontouchend = null;
                document.ontouchmove = null;
            }
        }

        window.adicionarCorte = () => {
            const id = document.getElementById('cut-prod-id').value;
            const w = document.getElementById('cut-w').value;
            const h = document.getElementById('cut-h').value;
            const p = produtos.find(x => x.id === id);

            if(!w || !h) { alert("Defina as medidas."); return; }
            if(parseFloat(w) > p.dimW || parseFloat(h) > p.dimH) { alert("Corte maior que a pe√ßa!"); return; }

            cortes.push({ origId: id, origName: p.nome, origW: p.dimW, origH: p.dimH, cutW: w, cutH: h });

            atualizarSidebar();
            document.getElementById('modal-corte').style.display = 'none';
            document.getElementById('sidebar-cuts').classList.add('open');
            document.getElementById('main-layout').style.marginRight = '320px';
        };

        function atualizarSidebar() {
            const list = document.getElementById('cuts-list');
            list.innerHTML = '';
            if(cortes.length === 0) { list.innerHTML = "Vazio."; return; }
            cortes.forEach((c, idx) => {
                list.innerHTML += `
                    <div class="cut-item">
                        <div>
                            <div style="font-weight:bold; color:white;">CORTE: ${c.cutW}x${c.cutH}</div>
                            <div style="font-size:10px;">Origem: ${c.origName}</div>
                        </div>
                        <button onclick="rmCorte(${idx})" style="color:red; background:none; border:none;">X</button>
                    </div>
                `;
            });
        }
        window.rmCorte = (i) => { cortes.splice(i, 1); atualizarSidebar(); }

        window.finalizarCortes = async () => {
            if(cortes.length === 0) return;
            for(let c of cortes) {
                // 1. Remove pe√ßa original
                await deleteDoc(doc(db, "estoque", c.origId));
                
                // 2. Pergunta sobra
                const sobraW = prompt(`Pe√ßa Original: ${c.origW}x${c.origH}\nCorte: ${c.cutW}x${c.cutH}\n\nLargura SOBRA? (0 se acabou)`);
                const sobraH = prompt(`Altura SOBRA? (0 se acabou)`);
                
                if(sobraW > 0 && sobraH > 0) {
                    await addDoc(collection(db, "estoque"), {
                        setor: 'serralheria', nome: `Retalho ${c.origName}`, categoria: 'Retalho',
                        dimW: parseFloat(sobraW), dimH: parseFloat(sobraH), qtd: 1
                    });
                }
            }
            alert("Conclu√≠do!");
            cortes = [];
            atualizarSidebar();
            carregarEstoque();
        };

        // --- CRUD E MODAIS ---
        window.abrirModalProduto = () => {
            document.getElementById('prod-id').value = '';
            document.getElementById('prod-nome').value = '';
            document.getElementById('prod-dim-w').value = '';
            document.getElementById('prod-dim-h').value = '';
            document.getElementById('prod-qtd').value = '';
            
            const isSerr = config[setorAtual].isSerr;
            document.getElementById('div-dims').style.display = isSerr ? 'block' : 'none';
            document.getElementById('div-qtd').style.display = isSerr ? 'none' : 'block';
            document.getElementById('div-un').style.display = isSerr ? 'none' : 'block';
            document.getElementById('modal-prod').style.display = 'flex';
        };

        window.salvarProduto = async () => {
            const isSerr = config[setorAtual].isSerr;
            const dados = {
                setor: setorAtual,
                nome: document.getElementById('prod-nome').value,
                categoria: document.getElementById('prod-cat').value,
            };
            if(isSerr) {
                dados.dimW = parseFloat(document.getElementById('prod-dim-w').value);
                dados.dimH = parseFloat(document.getElementById('prod-dim-h').value);
                dados.unidade = 'p√ß'; dados.qtd = 1;
            } else {
                dados.qtd = parseFloat(document.getElementById('prod-qtd').value);
                dados.minimo = parseFloat(document.getElementById('prod-min').value);
                dados.unidade = document.getElementById('prod-un').value;
            }
            await addDoc(collection(db, "estoque"), dados);
            document.getElementById('modal-prod').style.display = 'none';
            carregarEstoque();
        };

        window.deletar = async (id) => { if(confirm("Excluir?")) await deleteDoc(doc(db, "estoque", id)); carregarEstoque(); };
        window.fecharModal = (id) => document.getElementById(id).style.display = 'none';
        window.abrirMov = (id) => { document.getElementById('mov-id').value = id; document.getElementById('modal-mov').style.display = 'flex'; };
        window.salvarMov = async (tipo) => {
            const id = document.getElementById('mov-id').value;
            const qtd = parseFloat(document.getElementById('mov-qtd').value);
            const p = produtos.find(x => x.id === id);
            let nova = parseFloat(p.qtd);
            if(tipo === 'entrada') nova += qtd; else nova -= qtd;
            await updateDoc(doc(db, "estoque", id), { qtd: nova });
            document.getElementById('modal-mov').style.display = 'none';
            carregarEstoque();
        };
    </script>
</body>
</html>
