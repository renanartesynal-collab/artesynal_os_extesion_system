<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estoque & Corte - Artesynal</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --bg-dark: #1a1a1a; --card-bg: #2c3e50; --purple: #9b59b6; --orange: #e67e22; --red: #e74c3c; --green: #2ecc71; --blue: #3498db; --text: #eee; }
        body { font-family: 'Mitra LT', 'Montserrat', sans-serif; margin: 0; padding: 0; background-color: var(--bg-dark); color: var(--text); overflow-x: hidden; }

        /* --- TELA SELE√á√ÉO --- */
        #sector-screen { display: flex; height: 100vh; width: 100%; align-items: center; justify-content: center; gap: 30px; position: fixed; top: 0; left: 0; background: var(--bg-dark); z-index: 1000; flex-wrap: wrap; padding: 20px;}
        .sector-btn { width: 300px; height: 200px; border-radius: 15px; border: none; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; font-family: 'Mitra LT', 'Montserrat', sans-serif; transition: transform 0.2s; text-decoration: none; color: white;}
        .sector-btn:hover { transform: scale(1.05); }
        .sec-imp { background: linear-gradient(135deg, #8e44ad, #c0392b); box-shadow: 0 0 20px rgba(142, 68, 173, 0.5); }
        .sec-serr { background: linear-gradient(135deg, #e67e22, #f1c40f); box-shadow: 0 0 20px rgba(230, 126, 34, 0.5); color: #222; }
        .sec-icon { font-size: 50px; margin-bottom: 10px; }
        .sec-title { font-size: 24px; font-weight: 900; text-transform: uppercase; }

        /* --- LAYOUT PRINCIPAL --- */
        #main-layout { display: none; padding: 20px; transition: 0.3s; margin-right: 0; }
        .header-est { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #555; padding-bottom: 15px; }
        h1 { margin: 0; color: var(--purple); font-size: 24px; text-transform: uppercase; }
        .btn-voltar { cursor: pointer; color: white; background: #555; padding: 8px 15px; border-radius: 5px; font-size: 12px; font-weight: bold; border:none; font-family: 'Mitra LT', 'Montserrat', sans-serif;}

        /* FILTROS E GRID */
        .filter-bar { display: flex; gap: 10px; margin-bottom: 20px; background: #333; padding: 10px; border-radius: 8px; flex-wrap: wrap;}
        .search-input, .cat-select { flex: 1; padding: 10px; border-radius: 5px; border: none; background: #444; color: white; min-width: 150px; font-family: 'Mitra LT', 'Montserrat', sans-serif;}
        
        /* GRIDS ESPEC√çFICOS SERRALHERIA */
        .serr-section { margin-bottom: 30px; display: none; }
        .serr-title { background: #222; padding: 10px; border-radius: 5px; border-left: 5px solid var(--orange); margin-bottom: 15px; font-weight: 900; text-transform: uppercase; font-size: 14px; color: var(--orange); }
        .grid-est { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }

        /* CARDS */
        .card-prod { background: var(--card-bg); border-radius: 10px; padding: 15px; position: relative; border-left: 5px solid var(--purple); box-shadow: 0 4px 10px rgba(0,0,0,0.3); transition: margin 0.2s, border 0.2s; }
        .card-prod.serralheria { border-left-color: var(--orange); cursor: grab; }
        .card-prod.coupled { margin-left: -20px !important; border-left: 5px solid var(--green) !important; z-index: 10; box-shadow: -5px 0 10px rgba(0,0,0,0.5); }
        .card-prod.dragging { opacity: 0.5; }

        .prod-header { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .prod-cat { background: rgba(0,0,0,0.3); padding: 2px 8px; border-radius: 4px; font-size: 10px; color: #ccc; }
        .prod-name { font-size: 18px; font-weight: 800; color: white; margin-bottom: 5px; }
        .prod-dims { font-size: 14px; color: var(--orange); font-weight: bold; margin-bottom: 10px; display: block; }

        .btn-open-peca { background: var(--blue); color: white; width: 100%; border: none; padding: 10px; border-radius: 5px; font-weight: 900; cursor: pointer; font-family: inherit; }

        /* MODAIS */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 2000; justify-content: center; align-items: center; padding: 20px; }
        .modal-box { background: #333; padding: 25px; border-radius: 10px; width: 100%; max-width: 500px; position: relative; border: 1px solid #444; }
        .form-row { display: flex; gap: 10px; margin-bottom: 15px; }
        label { display: block; font-size: 11px; color: #ccc; margin-bottom: 5px; font-weight: bold; }
        input, select, textarea { width: 100%; padding: 12px; background: #444; border: none; border-radius: 5px; color: white; box-sizing: border-box; font-family: 'Mitra LT', 'Montserrat', sans-serif;}

        /* --- LAYOUT DA ETIQUETA (10x3cm) --- */
        #etiqueta-print {
            display: none; /* Escondido no navegador */
            width: 100mm;
            height: 30mm;
            background: #fff;
            color: #000;
            padding: 2mm;
            box-sizing: border-box;
            border: 1px solid #000;
            position: relative;
            overflow: hidden;
        }

        .et-container {
            display: flex;
            width: 100%;
            height: 100%;
            align-items: center;
            justify-content: space-between;
        }

        .et-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 100%;
        }

        .et-header {
            font-size: 12pt;
            font-weight: 900;
            text-transform: uppercase;
            border-bottom: 1.5pt solid #000;
            margin-bottom: 2pt;
            padding-bottom: 1pt;
            display: flex;
            justify-content: space-between;
        }

        .et-main-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2pt;
        }

        .et-field {
            font-size: 8pt;
            margin-bottom: 1pt;
        }

        .et-label {
            font-weight: 900;
            font-size: 7pt;
            color: #333;
            text-transform: uppercase;
            display: block;
        }

        .et-value {
            font-size: 9pt;
            font-weight: 700;
        }

        .et-qrcode-area {
            width: 26mm;
            height: 26mm;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fff;
            margin-left: 2mm;
        }

        /* --- CONFIGURA√á√ÉO DE IMPRESS√ÉO --- */
        @media print {
            body * { display: none !important; }
            #etiqueta-print, #etiqueta-print * { display: block !important; }
            #etiqueta-print {
                display: block !important;
                position: absolute;
                top: 0;
                left: 0;
                width: 100mm;
                height: 30mm;
            }
            .et-container { display: flex !important; }
            .et-qrcode-area canvas, .et-qrcode-area img { 
                width: 24mm !important; 
                height: 24mm !important; 
            }
            @page {
                size: 100mm 30mm;
                margin: 0;
            }
        }

        .fab-add { position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; background: var(--green); color: white; border-radius: 50%; border: none; font-size: 30px; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.5); cursor: pointer; z-index: 100; }
    </style>
</head>
<body>

    <div id="sector-screen">
        <button class="sector-btn sec-imp" onclick="selecionarSetor('impressao')">
            <div class="sec-icon">üñ®Ô∏è</div>
            <div class="sec-title">Sala de Impress√£o</div>
            <span style="font-size:10px; color:white;">Lonas, Tintas, Rolos</span>
        </button>
        <button class="sector-btn sec-serr" onclick="selecionarSetor('serralheria')">
            <div class="sec-icon">üõ†Ô∏è</div>
            <div class="sec-title">Serralheria</div>
            <span style="font-size:10px; color:black;">Chapas, Cortes, Pe√ßas</span>
        </button>
        <div style="width:100%; text-align:center; margin-top: 20px;">
            <a href="#" id="link-voltar-setor" style="color:#aaa; text-decoration:none; font-weight:bold; padding: 10px;">‚¨Ö VOLTAR AO PAINEL</a>
        </div>
    </div>

    <div id="main-layout">
        <div class="header-est">
            <h1 id="page-title">Estoque</h1>
            <button class="btn-voltar" onclick="location.reload()">üîÑ TROCAR SETOR</button>
        </div>

        <div class="filter-bar">
            <input type="text" id="search-input" class="search-input" placeholder="Buscar material..." onkeyup="filtrarEstoque()">
            <select id="cat-filter" class="cat-select" onchange="filtrarEstoque()">
                <option value="Todos">Todas Categorias</option>
            </select>
        </div>

        <div id="serr-sections">
            <div class="serr-section" id="sec-ACM"><div class="serr-title">Chapas ACM</div><div class="grid-est" id="grid-ACM"></div></div>
            <div class="serr-section" id="sec-PVC"><div class="serr-title">Chapas PVC</div><div class="grid-est" id="grid-PVC"></div></div>
            <div class="serr-section" id="sec-ACRILICO"><div class="serr-title">Acr√≠lico</div><div class="grid-est" id="grid-ACRILICO"></div></div>
            <div class="serr-section" id="sec-OUTROS"><div class="serr-title">Outros Metais/Madeiras</div><div class="grid-est" id="grid-OUTROS"></div></div>
        </div>

        <div class="grid-est" id="grid-estoque-geral"></div>
        
        <button class="fab-add" onclick="abrirModalProduto()">+</button>
    </div>

    <div id="modal-peca" class="modal-overlay">
        <div class="modal-box">
            <h2 id="m-nome" style="color:var(--orange); margin:0;">Nome da Pe√ßa</h2>
            <p id="m-dim" style="font-size:20px; font-weight:900; margin:10px 0;"></p>
            
            <div style="background:#222; padding:15px; border-radius:8px; margin:20px 0;">
                <label>REALIZAR CORTE (cm)</label>
                <div class="form-row">
                    <input type="number" id="corte-w" placeholder="L">
                    <input type="number" id="corte-h" placeholder="A">
                    <button onclick="executarCorte()" style="background:var(--orange); color:white; border:none; padding:10px 20px; border-radius:5px; font-weight:bold; cursor:pointer;">CORTAR</button>
                </div>
            </div>

            <div style="display:flex; gap:10px;">
                <button onclick="abrirPainelEtiqueta()" style="flex:1; background:var(--blue); color:white; border:none; padding:12px; border-radius:5px; font-weight:bold; cursor:pointer;">GERAR ETIQUETA</button>
                <button onclick="deletarPeca()" style="background:var(--red); border:none; padding:12px; border-radius:5px; cursor:pointer;">üóëÔ∏è</button>
            </div>
            <button onclick="fecharModal('modal-peca')" style="width:100%; background:none; color:#666; border:none; margin-top:15px; cursor:pointer;">FECHAR</button>
        </div>
    </div>

    <div id="modal-etiqueta" class="modal-overlay">
        <div class="modal-box">
            <h3 style="margin-top:0;">Configurar Etiqueta</h3>
            <label>N¬∫ DA O.S.</label>
            <input type="text" id="et-os" placeholder="0000">
            <label>LOCAL DE CORTE</label>
            <select id="et-local">
                <option value="Decorletras">Decorletras</option>
                <option value="MD Corte">MD Corte</option>
                <option value="W.A. Corte a Laser">W.A. Corte a Laser</option>
            </select>
            <label>N¬∫ DO CORTE</label>
            <input type="number" id="et-num" value="1">
            
            <button onclick="imprimirEtiquetaFinal()" style="width:100%; background:var(--green); color:white; border:none; padding:15px; border-radius:5px; font-weight:900; margin-top:20px; cursor:pointer;">IMPRIMIR (10x3cm)</button>
            <button onclick="fecharModal('modal-etiqueta')" style="width:100%; background:none; color:#666; border:none; margin-top:10px; cursor:pointer;">CANCELAR</button>
        </div>
    </div>

    <div id="modal-mov" class="modal-overlay">
        <div class="modal-box">
            <h2 style="margin-top:0;">Ajustar Estoque</h2>
            <input type="hidden" id="mov-id">
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <button style="flex:1; background:var(--green); border:none; padding:10px; color:white; font-weight:bold; border-radius:5px; cursor:pointer;" onclick="salvarMov('entrada')">ENTRADA (+)</button>
                <button style="flex:1; background:var(--red); border:none; padding:10px; color:white; font-weight:bold; border-radius:5px; cursor:pointer;" onclick="salvarMov('saida')">BAIXA (-)</button>
            </div>
            <input type="number" id="mov-qtd" placeholder="Quantidade">
            <button onclick="fecharModal('modal-mov')" style="width:100%; background:none; color:#666; border:none; margin-top:15px; cursor:pointer;">Cancelar</button>
        </div>
    </div>

    <div id="modal-prod" class="modal-overlay">
        <div class="modal-box">
            <h2 id="modal-title">Novo Material</h2>
            <label>NOME DO MATERIAL / CHAPA</label>
            <input type="text" id="prod-nome">
            
            <div class="form-row" style="margin-top:15px;">
                <div style="flex:1;"><label>CATEGORIA</label><select id="prod-cat"></select></div>
                <div style="flex:1;" id="div-un"><label>UNIDADE</label><select id="prod-un"><option value="un">Unidade</option><option value="m">Metros</option><option value="m¬≤">m¬≤</option><option value="L">Litros</option></select></div>
            </div>

            <div id="div-dims" style="display:none; background:#222; padding:10px; border-radius:5px; margin-top:15px;">
                <label style="color:var(--orange);">DIMENS√ïES (cm)</label>
                <div class="form-row"><input type="number" id="prod-dim-w" placeholder="Largura"><input type="number" id="prod-dim-h" placeholder="Altura"></div>
            </div>

            <div id="div-qtd" style="margin-top:15px;">
                <div class="form-row">
                    <div style="flex:1;"><label>QTD ATUAL</label><input type="number" id="prod-qtd"></div>
                    <div style="flex:1;"><label>M√çNIMO</label><input type="number" id="prod-min"></div>
                </div>
            </div>

            <button class="btn-open-peca" style="background:var(--green); margin-top:20px;" onclick="salvarProduto()">SALVAR NO ESTOQUE</button>
            <button onclick="fecharModal('modal-prod')" style="width:100%; background:none; color:#666; border:none; margin-top:10px; cursor:pointer;">CANCELAR</button>
        </div>
    </div>

    <div id="etiqueta-print">
        <div class="et-container">
            <div class="et-content">
                <div class="et-header">
                    <span id="p-nome">MATERIAL</span>
                </div>
                <div class="et-main-info">
                    <div class="et-field">
                        <span class="et-label">Dimens√µes</span>
                        <span class="et-value" id="p-dim">00 x 00 cm</span>
                    </div>
                    <div class="et-field">
                        <span class="et-label">N¬∫ O.S.</span>
                        <span class="et-value" id="p-os">0000</span>
                    </div>
                    <div class="et-field">
                        <span class="et-label">Local</span>
                        <span class="et-value" id="p-local">Decorletras</span>
                    </div>
                    <div class="et-field">
                        <span class="et-label">Corte</span>
                        <span class="et-value" id="p-num">01</span>
                    </div>
                </div>
            </div>
            <div class="et-qrcode-area" id="p-qrcode"></div>
        </div>
    </div>

    <script type="module">
        import { db, ROTAS } from "./config.js";
        import { collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        document.getElementById('link-voltar-setor').href = ROTAS.painel;

        let setorAtual = '';
        let produtos = [];
        let pecaSelecionada = null;

        const config = {
            'impressao': { color: 'var(--purple)', cats: ['Lona','Adesivo','Tinta','Outros'], isSerr: false },
            'serralheria': { color: 'var(--orange)', cats: ['ACM','PVC','Acr√≠lico','Outros'], isSerr: true }
        };

        window.selecionarSetor = (setor) => {
            setorAtual = setor;
            document.getElementById('sector-screen').style.display = 'none';
            document.getElementById('main-layout').style.display = 'block';
            document.getElementById('page-title').innerText = setor === 'impressao' ? 'Sala de Impress√£o' : 'Serralheria';
            document.getElementById('page-title').style.color = config[setor].color;

            document.getElementById('serr-sections').style.display = config[setor].isSerr ? 'block' : 'none';
            document.getElementById('grid-estoque-geral').style.display = config[setor].isSerr ? 'none' : 'grid';

            const sel = document.getElementById('cat-filter');
            const selModal = document.getElementById('prod-cat');
            sel.innerHTML = '<option value="Todos">Todas</option>';
            selModal.innerHTML = '';
            config[setor].cats.forEach(c => {
                sel.innerHTML += `<option value="${c}">${c}</option>`;
                selModal.innerHTML += `<option value="${c}">${c}</option>`;
            });

            ouvirEstoque();
        };

        function ouvirEstoque() {
            const q = query(collection(db, "estoque"), where("setor", "==", setorAtual));
            onSnapshot(q, (snapshot) => {
                produtos = [];
                snapshot.forEach(d => { let item = d.data(); item.id = d.id; produtos.push(item); });
                renderizar();
            });
        }

        function renderizar() {
            const isSerr = config[setorAtual].isSerr;
            if(isSerr) {
                document.querySelectorAll('.serr-section .grid-est').forEach(g => g.innerHTML = '');
                document.querySelectorAll('.serr-section').forEach(s => s.style.display = 'none');

                produtos.forEach(p => {
                    const catLimpa = p.categoria.toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                    const gridID = document.getElementById(`grid-${catLimpa}`) ? catLimpa : 'OUTROS';
                    const grid = document.getElementById(`grid-${gridID}`);
                    document.getElementById(`sec-${gridID}`).style.display = 'block';

                    const card = document.createElement('div');
                    card.className = `card-prod serralheria ${p.coupledTo ? 'coupled' : ''}`;
                    card.draggable = true;
                    card.id = p.id;
                    card.innerHTML = `
                        <div class="prod-header"><span class="prod-cat">${p.categoria}</span></div>
                        <div class="prod-name">${p.nome}</div>
                        <span class="prod-dims">${p.dimW} x ${p.dimH} cm</span>
                        <button class="btn-open-peca" onclick="abrirPeca('${p.id}')">ABRIR PE√áA</button>
                    `;

                    card.addEventListener('dragstart', (e) => { e.dataTransfer.setData('pecaID', p.id); card.classList.add('dragging'); });
                    card.addEventListener('dragend', () => card.classList.remove('dragging'));
                    card.addEventListener('dragover', (e) => e.preventDefault());
                    card.addEventListener('drop', async (e) => {
                        e.preventDefault();
                        const idArrastado = e.dataTransfer.getData('pecaID');
                        if(idArrastado !== p.id) { await updateDoc(doc(db, "estoque", idArrastado), { coupledTo: p.id }); }
                    });

                    grid.appendChild(card);
                });
            } else {
                const grid = document.getElementById('grid-estoque-geral');
                grid.innerHTML = '';
                produtos.forEach(p => {
                    grid.innerHTML += `
                        <div class="card-prod ${p.qtd <= p.minimo ? 'low-stock' : ''}">
                            <div class="prod-header"><span class="prod-cat">${p.categoria}</span></div>
                            <div class="prod-name">${p.nome}</div>
                            <div style="background:#222; padding:10px; border-radius:8px; display:flex; justify-content:space-between; align-items:center;">
                                <div><b style="font-size:20px;">${p.qtd}</b> <small>${p.unidade}</small></div>
                                <button class="btn-voltar" style="background:var(--blue)" onclick="abrirMov('${p.id}')">AJUSTAR</button>
                            </div>
                        </div>
                    `;
                });
            }
        }

        window.abrirPeca = (id) => {
            pecaSelecionada = produtos.find(x => x.id === id);
            document.getElementById('m-nome').innerText = pecaSelecionada.nome;
            document.getElementById('m-dim').innerText = `${pecaSelecionada.dimW} x ${pecaSelecionada.dimH} cm`;
            document.getElementById('modal-peca').style.display = 'flex';
        };

        window.executarCorte = async () => {
            const cw = parseFloat(document.getElementById('corte-w').value);
            const ch = parseFloat(document.getElementById('corte-h').value);
            if(!cw || !ch || cw > pecaSelecionada.dimW || ch > pecaSelecionada.dimH) { alert("Medidas inv√°lidas!"); return; }

            if(confirm("Deseja realizar o corte? A pe√ßa original ser√° reduzida.")){
                const sobraW = pecaSelecionada.dimW - cw;
                const sobraH = pecaSelecionada.dimH - ch;
                await updateDoc(doc(db, "estoque", pecaSelecionada.id), {
                    dimW: sobraW > 0 ? sobraW : pecaSelecionada.dimW,
                    dimH: sobraH > 0 ? sobraH : pecaSelecionada.dimH,
                    nome: pecaSelecionada.nome + " (Sobra)"
                });
                await addDoc(collection(db, "estoque"), {
                    setor: 'serralheria', nome: pecaSelecionada.nome + " (Corte)",
                    categoria: pecaSelecionada.categoria, dimW: cw, dimH: ch, qtd: 1, unidade: 'p√ß'
                });
                alert("Corte realizado!");
                fecharModal('modal-peca');
            }
        };

        window.deletarPeca = async () => {
            if(confirm("Excluir esta pe√ßa permanentemente?")) {
                await deleteDoc(doc(db, "estoque", pecaSelecionada.id));
                fecharModal('modal-peca');
            }
        };

        window.abrirPainelEtiqueta = () => { document.getElementById('modal-etiqueta').style.display = 'flex'; };

        window.imprimirEtiquetaFinal = () => {
            const os = document.getElementById('et-os').value;
            const local = document.getElementById('et-local').value;
            const num = document.getElementById('et-num').value;

            // Preenche dados
            document.getElementById('p-nome').innerText = pecaSelecionada.nome;
            document.getElementById('p-dim').innerText = `${pecaSelecionada.dimW} x ${pecaSelecionada.dimH} cm`;
            document.getElementById('p-os').innerText = os || '----';
            document.getElementById('p-local').innerText = local;
            document.getElementById('p-num').innerText = num.padStart(2, '0');

            const qrCont = document.getElementById('p-qrcode');
            qrCont.innerHTML = '';
            const link = window.location.href.split('?')[0] + "?id=" + pecaSelecionada.id;
            
            // Gerar QR
            new QRCode(qrCont, { text: link, width: 128, height: 128, correctLevel: QRCode.CorrectLevel.H });

            // Pequeno delay para o QR Code renderizar antes de abrir o print
            setTimeout(() => { window.print(); }, 400);
        };

        window.abrirModalProduto = () => {
            const isSerr = config[setorAtual].isSerr;
            document.getElementById('div-dims').style.display = isSerr ? 'block' : 'none';
            document.getElementById('div-un').style.display = isSerr ? 'none' : 'block';
            document.getElementById('div-qtd').style.display = isSerr ? 'none' : 'block';
            document.getElementById('modal-prod').style.display = 'flex';
        };

        window.salvarProduto = async () => {
            const isSerr = config[setorAtual].isSerr;
            const dados = {
                setor: setorAtual,
                nome: document.getElementById('prod-nome').value,
                categoria: document.getElementById('prod-cat').value,
            };
            if(isSerr) {
                dados.dimW = parseFloat(document.getElementById('prod-dim-w').value);
                dados.dimH = parseFloat(document.getElementById('prod-dim-h').value);
                dados.qtd = 1; dados.unidade = 'p√ß';
            } else {
                dados.qtd = parseFloat(document.getElementById('prod-qtd').value);
                dados.minimo = parseFloat(document.getElementById('prod-min').value);
                dados.unidade = document.getElementById('prod-un').value;
            }
            await addDoc(collection(db, "estoque"), dados);
            fecharModal('modal-prod');
        };

        window.abrirMov = (id) => { document.getElementById('mov-id').value = id; document.getElementById('modal-mov').style.display = 'flex'; };
        window.salvarMov = async (tipo) => {
            const id = document.getElementById('mov-id').value;
            const qtdAlt = parseFloat(document.getElementById('mov-qtd').value);
            const p = produtos.find(x => x.id === id);
            let novaQtd = tipo === 'entrada' ? p.qtd + qtdAlt : p.qtd - qtdAlt;
            await updateDoc(doc(db, "estoque", id), { qtd: novaQtd });
            fecharModal('modal-mov');
        };

        window.fecharModal = (id) => document.getElementById(id).style.display = 'none';
        window.filtrarEstoque = () => {};
    </script>
</body>
</html>
