<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Serralheria Pro - Artesynal</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { 
            --bg-dark: #121212; --card-bg: #1e1e1e; --orange: #e67e22; 
            --blue: #3498db; --red: #e74c3c; --green: #2ecc71; --text: #eee;
        }
        body { font-family: 'Mitra LT', 'Montserrat', sans-serif; margin: 0; background: var(--bg-dark); color: var(--text); }

        /* TELA SELE√á√ÉO */
        #sector-screen { display: flex; height: 100vh; align-items: center; justify-content: center; gap: 20px; flex-direction: column; }
        .sector-btn { width: 280px; padding: 40px; border-radius: 15px; border: none; cursor: pointer; font-weight: 900; font-size: 20px; transition: 0.3s; }
        .sec-serr { background: var(--orange); color: #000; }

        /* LAYOUT SERRALHERIA */
        #main-layout { display: none; padding: 20px; }
        .header-est { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--orange); padding-bottom: 10px; margin-bottom: 20px; }
        
        /* DIVIS√ìRIAS */
        .material-section { margin-bottom: 40px; }
        .section-title { 
            background: #333; padding: 10px 20px; border-radius: 5px; 
            color: var(--orange); font-weight: 900; text-transform: uppercase;
            margin-bottom: 15px; border-left: 5px solid var(--orange);
            display: flex; justify-content: space-between;
        }

        /* GRID E CARDS */
        .grid-serr { 
            display: flex; flex-wrap: wrap; gap: 15px; min-height: 100px;
            padding: 10px; border: 1px dashed #333; border-radius: 10px;
        }

        .card-peca { 
            background: var(--card-bg); width: 220px; border-radius: 8px; 
            padding: 15px; border: 1px solid #333; cursor: grab;
            position: relative; transition: transform 0.2s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .card-peca.dragging { opacity: 0.5; transform: scale(0.9); }
        .card-peca.coupled { margin-left: -10px; border-left: 3px solid var(--green); }

        .peca-name { font-weight: 900; font-size: 14px; margin-bottom: 5px; color: var(--orange); }
        .peca-dim { font-size: 18px; font-weight: 900; margin-bottom: 10px; }
        
        .btn-card-action { 
            width: 100%; padding: 8px; margin-top: 5px; border: none; 
            border-radius: 4px; font-weight: bold; cursor: pointer; font-family: inherit;
        }
        .btn-open { background: #444; color: white; }

        /* MODAIS */
        .modal-overlay { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.9); z-index: 1000; justify-content: center; align-items: center; 
        }
        .modal-box { 
            background: #222; padding: 30px; border-radius: 12px; width: 90%; max-width: 500px; 
            border: 1px solid #444;
        }

        /* ETIQUETA */
        #etiqueta-print {
            width: 10cm; height: 3cm; background: white; color: black;
            padding: 5px; display: none; grid-template-columns: 1fr 80px;
            font-size: 10px; border: 1px solid #000; box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        .etiqueta-info span { display: block; font-weight: bold; border-bottom: 1px solid #eee; margin-bottom: 2px; }

        @media print {
            body * { display: none; }
            #etiqueta-print { display: grid !important; position: absolute; top: 0; left: 0; }
        }

        .fab-add { 
            position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; 
            background: var(--orange); border-radius: 50%; border: none; font-size: 30px; 
            cursor: pointer; font-weight: bold; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body>

    <div id="sector-screen">
        <h2 style="color:var(--orange)">ESTOQUE ARTESYNAL</h2>
        <button class="sector-btn sec-serr" onclick="ativarSerralheria()">üõ†Ô∏è SERRALHERIA</button>
        <a href="index.html" style="color:#666; text-decoration:none">VOLTAR AO PAINEL</a>
    </div>

    <div id="main-layout">
        <div class="header-est">
            <h1 style="color:var(--orange)">ESTOQUE SERRALHERIA</h1>
            <button onclick="location.reload()" style="background:#333; color:white; border:none; padding:10px; border-radius:5px; cursor:pointer">VOLTAR</button>
        </div>

        <div id="sections-container">
            <div class="material-section">
                <div class="section-title"><span>CHAPA ACM</span> <small id="count-acm">0 pe√ßas</small></div>
                <div class="grid-serr" id="grid-ACM" ondragover="allowDrop(event)" ondrop="drop(event, 'ACM')"></div>
            </div>

            <div class="material-section">
                <div class="section-title"><span>CHAPA PVC</span> <small id="count-pvc">0 pe√ßas</small></div>
                <div class="grid-serr" id="grid-PVC" ondragover="allowDrop(event)" ondrop="drop(event, 'PVC')"></div>
            </div>

            <div class="material-section">
                <div class="section-title"><span>CHAPA ACR√çLICO</span> <small id="count-acrilico">0 pe√ßas</small></div>
                <div class="grid-serr" id="grid-ACRILICO" ondragover="allowDrop(event)" ondrop="drop(event, 'ACRILICO')"></div>
            </div>
        </div>
    </div>

    <div id="modal-peca" class="modal-overlay">
        <div class="modal-box">
            <h2 id="m-nome" style="color:var(--orange); margin-top:0;">Nome da Pe√ßa</h2>
            <p id="m-dim" style="font-size:24px; font-weight:900; margin: 10px 0;"></p>
            <p id="m-tipo" style="color:#888;"></p>
            
            <hr style="border:0; border-top:1px solid #444;">
            
            <div style="background:#111; padding:15px; border-radius:8px; margin-top:15px;">
                <label>NOVO CORTE (cm):</label>
                <div style="display:flex; gap:10px; margin-top:5px;">
                    <input type="number" id="corte-w" placeholder="L">
                    <input type="number" id="corte-h" placeholder="A">
                    <button onclick="realizarCorte()" style="background:var(--orange); border:none; padding:10px; border-radius:5px; font-weight:bold; cursor:pointer">CORTAR</button>
                </div>
            </div>

            <div style="margin-top:20px; display:flex; gap:10px;">
                <button onclick="abrirPainelEtiqueta()" style="flex:1; background:var(--blue); border:none; padding:12px; color:white; font-weight:bold; border-radius:5px; cursor:pointer">GERAR ETIQUETA</button>
                <button onclick="deletarPecaConfirmada()" style="background:var(--red); border:none; padding:12px; color:white; border-radius:5px; cursor:pointer">üóëÔ∏è</button>
            </div>
            
            <button onclick="fecharModal()" style="width:100%; margin-top:10px; background:none; color:#666; border:none; cursor:pointer">FECHAR</button>
        </div>
    </div>

    <div id="modal-etiqueta" class="modal-overlay">
        <div class="modal-box">
            <h3>Gerar Etiqueta T√©cnica</h3>
            <label>N¬∫ OS do Servi√ßo</label>
            <input type="text" id="e-os" placeholder="0000">
            <label>Local de Corte</label>
            <select id="e-local">
                <option value="Decorletras">Decorletras</option>
                <option value="MD Corte">MD Corte</option>
                <option value="W.A. Corte a Laser">W.A. Corte a Laser</option>
            </select>
            <label>N¬∫ do Corte</label>
            <input type="number" id="e-num" value="1">
            
            <div id="qrcode-temp" style="display:none"></div>

            <button onclick="imprimirEtiqueta()" style="width:100%; background:var(--green); border:none; padding:15px; color:white; font-weight:bold; border-radius:5px; margin-top:15px; cursor:pointer">üñ®Ô∏è IMPRIMIR ETIQUETA</button>
            <button onclick="fecharModalEtiqueta()" style="width:100%; margin-top:10px; background:none; color:#666; border:none; cursor:pointer">CANCELAR</button>
        </div>
    </div>

    <div id="etiqueta-print">
        <div class="etiqueta-info">
            <span id="p-tipo-label">TIPO: ---</span>
            <span id="p-dim-label">TAM: ---</span>
            <span id="p-os-label">OS: ---</span>
            <span id="p-local-label">LOCAL: ---</span>
            <span id="p-num-label">CORTE: ---</span>
        </div>
        <div id="p-qrcode" style="display:flex; align-items:center; justify-content:center;"></div>
    </div>

    <button class="fab-add" onclick="abrirNovoCadastro()">+</button>

    <script type="module">
        import { db, ROTAS } from "./config.js";
        import { collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        let pecas = [];
        let pecaSelecionada = null;

        window.ativarSerralheria = () => {
            document.getElementById('sector-screen').style.display = 'none';
            document.getElementById('main-layout').style.display = 'block';
            ouvirBanco();
        };

        function ouvirBanco() {
            const q = query(collection(db, "estoque_serralheria"));
            onSnapshot(q, (snapshot) => {
                pecas = [];
                snapshot.forEach(doc => pecas.push({id: doc.id, ...doc.data()}));
                renderizarPecas();
            });
        }

        function renderizarPecas() {
            const grids = {
                'ACM': document.getElementById('grid-ACM'),
                'PVC': document.getElementById('grid-PVC'),
                'ACRILICO': document.getElementById('grid-ACRILICO')
            };

            Object.values(grids).forEach(g => g.innerHTML = '');

            pecas.forEach(p => {
                const card = document.createElement('div');
                card.className = `card-peca ${p.coupled ? 'coupled' : ''}`;
                card.draggable = true;
                card.id = p.id;
                card.dataset.tipo = p.tipo;
                
                card.innerHTML = `
                    <div class="peca-name">${p.nome}</div>
                    <div class="peca-dim">${p.w}x${p.h}<small>cm</small></div>
                    <button class="btn-card-action btn-open" onclick="abrirPeca('${p.id}')">ABRIR</button>
                `;

                card.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', p.id);
                    card.classList.add('dragging');
                });

                card.addEventListener('dragend', () => card.classList.remove('dragging'));

                grids[p.tipo].appendChild(card);
            });

            // Atualiza contadores
            document.getElementById('count-acm').innerText = pecas.filter(x => x.tipo === 'ACM').length + ' pe√ßas';
            document.getElementById('count-pvc').innerText = pecas.filter(x => x.tipo === 'PVC').length + ' pe√ßas';
            document.getElementById('count-acrilico').innerText = pecas.filter(x => x.tipo === 'ACRILICO').length + ' pe√ßas';
        }

        // L√≥gica de Acoplar
        window.allowDrop = (e) => e.preventDefault();
        window.drop = async (e, tipoAlvo) => {
            e.preventDefault();
            const idArrastado = e.dataTransfer.getData('text/plain');
            const target = e.target.closest('.card-peca');

            if (target && target.id !== idArrastado) {
                // Se soltou em cima de outro card, acopla
                await updateDoc(doc(db, "estoque_serralheria", idArrastado), { coupled: true });
            } else {
                // Se soltou no grid vazio, desacopla
                await updateDoc(doc(db, "estoque_serralheria", idArrastado), { coupled: false });
            }
        };

        window.abrirPeca = (id) => {
            pecaSelecionada = pecas.find(x => x.id === id);
            document.getElementById('m-nome').innerText = pecaSelecionada.nome;
            document.getElementById('m-dim').innerText = `${pecaSelecionada.w} x ${pecaSelecionada.h} cm`;
            document.getElementById('m-tipo').innerText = `Material: ${pecaSelecionada.tipo}`;
            document.getElementById('modal-peca').style.display = 'flex';
        };

        window.realizarCorte = async () => {
            const cw = parseFloat(document.getElementById('corte-w').value);
            const ch = parseFloat(document.getElementById('corte-h').value);

            if (!cw || !ch || cw > pecaSelecionada.w || ch > pecaSelecionada.h) {
                alert("Medidas inv√°lidas ou maiores que a pe√ßa!");
                return;
            }

            const sobraW = pecaSelecionada.w - cw;
            const sobraH = pecaSelecionada.h - ch;

            // 1. Atualiza pe√ßa atual (vira o retalho maior ou sobra)
            await updateDoc(doc(db, "estoque_serralheria", pecaSelecionada.id), {
                w: sobraW > 0 ? sobraW : pecaSelecionada.w,
                h: sobraH > 0 ? sobraH : pecaSelecionada.h,
                nome: pecaSelecionada.nome + " (Sobra)"
            });

            // 2. Cria nova pe√ßa (o corte)
            await addDoc(collection(db, "estoque_serralheria"), {
                nome: pecaSelecionada.nome + " (Corte)",
                tipo: pecaSelecionada.tipo,
                w: cw,
                h: ch,
                coupled: false,
                data: new Date()
            });

            alert("Corte realizado! Nova pe√ßa gerada.");
            fecharModal();
        };

        window.abrirNovoCadastro = async () => {
            const nome = prompt("Nome da chapa:");
            const tipo = prompt("Tipo (ACM, PVC ou ACRILICO):").toUpperCase();
            const w = prompt("Largura (cm):");
            const h = prompt("Altura (cm):");

            if (nome && w && h) {
                await addDoc(collection(db, "estoque_serralheria"), {
                    nome, tipo, w: parseFloat(w), h: parseFloat(h), coupled: false, data: new Date()
                });
            }
        };

        window.deletarPecaConfirmada = async () => {
            if (confirm("Deseja realmente excluir esta pe√ßa do estoque?")) {
                await deleteDoc(doc(db, "estoque_serralheria", pecaSelecionada.id));
                fecharModal();
            }
        };

        window.abrirPainelEtiqueta = () => {
            document.getElementById('modal-etiqueta').style.display = 'flex';
        };

        window.imprimirEtiqueta = () => {
            const os = document.getElementById('e-os').value;
            const local = document.getElementById('e-local').value;
            const num = document.getElementById('e-num').value;

            document.getElementById('p-tipo-label').innerText = "TIPO: " + pecaSelecionada.tipo;
            document.getElementById('p-dim-label').innerText = `TAM: ${pecaSelecionada.w}x${pecaSelecionada.h}cm`;
            document.getElementById('p-os-label').innerText = "OS: " + os;
            document.getElementById('p-local-label').innerText = "LOCAL: " + local;
            document.getElementById('p-num-label').innerText = "CORTE: " + num;

            // Gera QR Code
            const qrContainer = document.getElementById('p-qrcode');
            qrContainer.innerHTML = '';
            // Link que aponta para o sistema filtrando pelo ID da pe√ßa
            const link = window.location.href.split('?')[0] + "?pecaId=" + pecaSelecionada.id;
            
            new QRCode(qrContainer, {
                text: link,
                width: 70,
                height: 70
            });

            setTimeout(() => { window.print(); }, 500);
        };

        window.fecharModal = () => document.getElementById('modal-peca').style.display = 'none';
        window.fecharModalEtiqueta = () => document.getElementById('modal-etiqueta').style.display = 'none';

    </script>
</body>
</html>
