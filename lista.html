<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de O.S. - Artesynal</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #333;
            --card-bg: #2c3e50;
            --yellow: #f1c40f;
            --blue: #00aeef;
            --green: #00a651;
            --red: #ed1c24;
            --text-gray: #bdc3c7;
        }

        body {
            font-family: 'Mitra LT', 'Montserrat', sans-serif;
            margin: 0; padding: 20px;
            background-color: var(--bg-dark);
            color: white;
        }

        /* CABE√áALHO */
        .header-lista {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; border-bottom: 2px solid #555; padding-bottom: 15px;
        }
        h1 { margin: 0; color: var(--yellow); font-size: 24px; text-transform: uppercase; }
        
        .btn-voltar {
            text-decoration: none; color: white; background: #555; 
            padding: 8px 15px; border-radius: 5px; font-size: 12px; font-weight: bold;
        }

        /* FILTROS */
        .filtros { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .btn-filtro {
            padding: 8px 15px; border: none; border-radius: 20px; cursor: pointer;
            font-weight: bold; font-size: 12px; background: #444; color: #ccc;
            transition: all 0.2s; font-family: 'Mitra LT', 'Montserrat', sans-serif;
        }
        .btn-filtro.ativo { background: var(--blue); color: white; transform: scale(1.05); }

        /* DIVIS√ìRIAS POR M√äS */
        .mes-grupo { margin-bottom: 15px; }
        .mes-header {
            background: #1a252f; padding: 12px 15px; border-radius: 8px;
            font-weight: 900; color: var(--yellow); cursor: pointer;
            display: flex; justify-content: space-between; align-items: center;
            text-transform: uppercase; letter-spacing: 1px;
            border-left: 4px solid var(--yellow);
            transition: background 0.2s;
        }
        .mes-header:hover { background: #23313f; }
        .mes-icon { font-size: 14px; color: white; }

        /* TABELA E CARDS COMPACTOS */
        .lista-grid {
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); 
            gap: 15px; 
            padding-top: 15px;
        }

        .os-card {
            background: var(--card-bg); border-radius: 8px; padding: 15px;
            display: flex; flex-direction: column;
            border-top: 4px solid #555; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: transform 0.2s; position: relative;
        }
        .os-card:hover { transform: translateY(-5px); box-shadow: 0 6px 15px rgba(0,0,0,0.4); }

        .status-pago { border-top-color: var(--green); }
        .status-pendente { border-top-color: var(--red); }
        .status-andamento { border-top-color: var(--blue); }

        .os-header-card { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid #444; padding-bottom: 5px;}
        .os-num { font-size: 14px; color: white; font-weight: 900; background: #1a252f; padding: 2px 8px; border-radius: 4px;}
        .os-data { font-size: 10px; color: #999; }
        
        .os-cliente { font-size: 18px; font-weight: 800; color: white; margin-bottom: 2px; line-height: 1.1;}
        .os-servico { font-size: 12px; color: var(--text-gray); margin-bottom: 15px; flex-grow: 1; }
        .os-valor { font-weight: 900; font-size: 18px; color: var(--yellow); margin-bottom: 15px; text-align: left; }

        .actions { display: flex; gap: 8px; width: 100%; mt-auto;}
        .btn-acao {
            flex: 1; border: none; padding: 10px; border-radius: 5px; cursor: pointer; 
            font-weight: bold; font-family: 'Mitra LT', 'Montserrat', sans-serif; font-size: 11px;
        }
        .btn-abrir { background: var(--blue); color: white; }
        .btn-del { background: var(--red); color: white; flex: 0.3; }

        #loading { text-align: center; color: #aaa; margin-top: 50px; font-size: 14px;}
    </style>
</head>
<body>

    <div class="header-lista">
        <h1>Minhas O.S.</h1>
        <a href="#" id="link-voltar" class="btn-voltar">‚¨Ö VOLTAR AO PAINEL</a>
    </div>

    <div class="filtros">
        <button class="btn-filtro ativo" onclick="filtrar('todos', this)">TODOS</button>
        <button class="btn-filtro" onclick="filtrar('pendente', this)">PENDENTES</button>
        <button class="btn-filtro" onclick="filtrar('pago', this)">PAGOS</button>
    </div>

    <div id="loading">A carregar ordens de servi√ßo...</div>
    <div id="lista-os-container"></div>

    <script type="module">
        // 1. IMPORTA√á√ïES DO CONFIG
        import { db, ROTAS } from "./config.js";
        import { collection, getDocs, doc, deleteDoc, orderBy, query } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        document.getElementById('link-voltar').href = ROTAS.painel;
        let todasOS = []; 

        async function carregarLista() {
            const container = document.getElementById('lista-os-container');
            const loading = document.getElementById('loading');
            container.innerHTML = '';
            loading.style.display = 'block';
            
            try {
                const q = query(collection(db, "ordens_servico"), orderBy("data_criacao", "desc"));
                const querySnapshot = await getDocs(q);
                
                todasOS = [];
                querySnapshot.forEach((doc) => {
                    let dados = doc.data();
                    dados.id = doc.id; 
                    todasOS.push(dados);
                });

                renderizar(todasOS);
                loading.style.display = 'none';

            } catch (error) {
                console.error("Erro:", error);
                loading.innerText = "Erro ao carregar. Verifique a liga√ß√£o ou a consola.";
            }
        }

        window.renderizar = function(lista) {
            const container = document.getElementById('lista-os-container');
            container.innerHTML = '';

            if (lista.length === 0) {
                container.innerHTML = '<div style="text-align:center; color:#555; margin-top: 20px;">Nenhuma O.S. encontrada.</div>';
                return;
            }

            // Agrupar por M√™s/Ano
            const grupos = {};
            const dataAtual = new Date();
            const mesAtualSort = `${dataAtual.getFullYear()}-${String(dataAtual.getMonth() + 1).padStart(2, '0')}`;

            lista.forEach(os => {
                let mesAnoSort = "0000-00";
                let mesAnoExibicao = "Sem Data";

                if (os.data_criacao && os.data_criacao.seconds) {
                    const d = new Date(os.data_criacao.seconds * 1000);
                    const ano = d.getFullYear();
                    const mes = String(d.getMonth() + 1).padStart(2, '0');
                    mesAnoSort = `${ano}-${mes}`;
                    
                    const nomeMes = d.toLocaleString('pt-PT', { month: 'long' });
                    mesAnoExibicao = `${nomeMes.charAt(0).toUpperCase() + nomeMes.slice(1)} ${ano}`;
                }

                if (!grupos[mesAnoSort]) {
                    grupos[mesAnoSort] = { titulo: mesAnoExibicao, itens: [] };
                }
                grupos[mesAnoSort].itens.push(os);
            });

            // Obter as chaves (ex: 2026-02) e ordenar de forma decrescente
            const chavesOrdenadas = Object.keys(grupos).sort((a, b) => b.localeCompare(a));

            chavesOrdenadas.forEach((chave, index) => {
                const grupo = grupos[chave];
                
                // Abre o m√™s se for o m√™s atual OU se for o primeiro m√™s da lista (caso n√£o existam O.S. no m√™s atual)
                const isAberto = (chave === mesAtualSort) || (index === 0 && !grupos[mesAtualSort]);
                const displayEstilo = isAberto ? 'grid' : 'none';
                const iconEstilo = isAberto ? '‚ñº' : '‚ñ∂';

                let htmlGrupo = `
                    <div class="mes-grupo">
                        <div class="mes-header" onclick="toggleMes('grid-${chave}', 'icon-${chave}')">
                            <span>üìÖ ${grupo.titulo} <span style="color:#888; font-size:10px; margin-left:10px;">(${grupo.itens.length} O.S.)</span></span>
                            <span class="mes-icon" id="icon-${chave}">${iconEstilo}</span>
                        </div>
                        <div class="lista-grid" id="grid-${chave}" style="display: ${displayEstilo};">
                `;

                grupo.itens.forEach(os => {
                    let statusClass = 'status-andamento';
                    if (os.status?.pago) statusClass = 'status-pago';
                    else if (!os.status?.pago && !os.status?.faturado) statusClass = 'status-pendente';

                    let dataFormatada = "--/--/----";
                    if (os.data_criacao && os.data_criacao.seconds) {
                        const d = new Date(os.data_criacao.seconds * 1000);
                        dataFormatada = d.toLocaleDateString('pt-PT');
                    }

                    htmlGrupo += `
                        <div class="os-card ${statusClass}">
                            <div class="os-header-card">
                                <span class="os-num">#${os.os_numero || '???'}</span>
                                <span class="os-data">${dataFormatada}</span>
                            </div>
                            <div class="os-cliente">${os.cliente || 'Sem Nome'}</div>
                            <div class="os-servico">${os.servico_titulo || 'Servi√ßo Gen√©rico'}</div>
                            <div class="os-valor">${os.valor_restante || 'R$ 0,00'}</div>
                            
                            <div class="actions">
                                <button class="btn-acao btn-abrir" onclick="abrirOS('${os.id}')">‚úèÔ∏è EDITAR</button>
                                <button class="btn-acao btn-del" onclick="deletarOS('${os.id}')">üóëÔ∏è</button>
                            </div>
                        </div>
                    `;
                });

                htmlGrupo += `</div></div>`;
                container.innerHTML += htmlGrupo;
            });
        }

        window.toggleMes = function(idContainer, idIcone) {
            const cont = document.getElementById(idContainer);
            const icon = document.getElementById(idIcone);
            if (cont.style.display === 'none') {
                cont.style.display = 'grid';
                icon.innerHTML = '‚ñº';
            } else {
                cont.style.display = 'none';
                icon.innerHTML = '‚ñ∂';
            }
        }

        window.deletarOS = async function(id) {
            if (confirm("Tem a certeza que deseja APAGAR esta O.S. permanentemente?")) {
                try {
                    await deleteDoc(doc(db, "ordens_servico", id));
                    alert("O.S. apagada!");
                    carregarLista(); 
                } catch (e) {
                    alert("Erro ao apagar: " + e);
                }
            }
        }

        window.filtrar = function(tipo, btn) {
            document.querySelectorAll('.btn-filtro').forEach(b => b.classList.remove('ativo'));
            btn.classList.add('ativo');

            if (tipo === 'todos') {
                renderizar(todasOS);
            } else if (tipo === 'pago') {
                const filtrados = todasOS.filter(os => os.status?.pago === true);
                renderizar(filtrados);
            } else if (tipo === 'pendente') {
                const filtrados = todasOS.filter(os => !os.status?.pago);
                renderizar(filtrados);
            }
        }

        window.abrirOS = function(id) {
            window.location.href = `${ROTAS.os}?id=${id}`;
        }

        carregarLista();
    </script>
</body>
</html>
