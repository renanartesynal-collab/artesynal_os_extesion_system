<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de O.S. - Artesynal</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #333;
            --card-bg: #2c3e50;
            --yellow: #f1c40f;
            --blue: #00aeef;
            --green: #00a651;
            --red: #ed1c24;
            --text-gray: #bdc3c7;
        }

        body {
            font-family: 'Mitra LT', 'Montserrat', sans-serif;
            margin: 0; padding: 20px;
            background-color: var(--bg-dark);
            color: white;
        }

        /* CABE√áALHO */
        .header-lista {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; border-bottom: 2px solid #555; padding-bottom: 15px;
        }
        h1 { margin: 0; color: var(--yellow); font-size: 24px; text-transform: uppercase; }
        
        .btn-voltar {
            text-decoration: none; color: white; background: #555; 
            padding: 8px 15px; border-radius: 5px; font-size: 12px; font-weight: bold;
        }

        /* FILTROS */
        .filtros { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .btn-filtro {
            padding: 8px 15px; border: none; border-radius: 20px; cursor: pointer;
            font-weight: bold; font-size: 12px; background: #444; color: #ccc;
            transition: all 0.2s; font-family: 'Mitra LT', 'Montserrat', sans-serif;
        }
        .btn-filtro.ativo { background: var(--blue); color: white; transform: scale(1.05); }

        /* TABELA (Cards no Mobile / Tabela no PC) */
        .lista-container {
            display: grid; gap: 10px;
        }

        .os-card {
            background: var(--card-bg); border-radius: 8px; padding: 15px;
            display: flex; align-items: center; justify-content: space-between;
            border-left: 5px solid #555; cursor: pointer; transition: transform 0.2s;
        }
        .os-card:hover { transform: translateX(5px); background: #34495e; }

        /* Cores da borda lateral baseada no status */
        .status-pago { border-left-color: var(--green); }
        .status-pendente { border-left-color: var(--red); }
        .status-andamento { border-left-color: var(--blue); }

        .os-info { flex: 1; }
        .os-num { font-size: 12px; color: #999; font-weight: bold; }
        .os-cliente { font-size: 16px; font-weight: 700; color: white; margin: 2px 0; }
        .os-servico { font-size: 12px; color: var(--text-gray); }
        .os-data { font-size: 10px; color: #777; margin-top: 5px;}

        .os-valor { 
            text-align: right; font-weight: 900; font-size: 14px; color: var(--yellow); margin-right: 15px;
        }

        .actions { display: flex; gap: 10px; }
        .btn-acao {
            border: none; padding: 8px; border-radius: 5px; cursor: pointer; font-weight: bold;
            font-family: 'Mitra LT', 'Montserrat', sans-serif;
        }
        .btn-abrir { background: var(--blue); color: white; }
        .btn-del { background: var(--red); color: white; }

        /* MENSAGEM DE CARREGANDO */
        #loading { text-align: center; color: #aaa; margin-top: 50px; }

        @media (max-width: 600px) {
            .os-card { flex-direction: column; align-items: flex-start; }
            .os-valor { text-align: left; margin: 10px 0; }
            .actions { width: 100%; justify-content: space-between; }
            .btn-acao { flex: 1; }
        }
    </style>
</head>
<body>

    <div class="header-lista">
        <h1>Minhas O.S.</h1>
        <a href="index.html" class="btn-voltar">‚¨Ö VOLTAR</a>
    </div>

    <div class="filtros">
        <button class="btn-filtro ativo" onclick="filtrar('todos', this)">TODOS</button>
        <button class="btn-filtro" onclick="filtrar('pendente', this)">PENDENTES</button>
        <button class="btn-filtro" onclick="filtrar('pago', this)">PAGOS</button>
    </div>

    <div id="loading">Carregando ordens de servi√ßo...</div>
    <div class="lista-container" id="lista-os">
        </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, deleteDoc, orderBy, query } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBxG9GNxfJxWiw8hpreTeShrG009svRmPI",
            authDomain: "artesynal-os-system.firebaseapp.com",
            projectId: "artesynal-os-system",
            storageBucket: "artesynal-os-system.firebasestorage.app",
            messagingSenderId: "539958005846",
            appId: "1:539958005846:web:9120505e097b56bf16ebf7"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        let todasOS = []; // Armazena localmente para filtrar sem gastar leitura

        // CARREGAR DADOS
        async function carregarLista() {
            const listaDiv = document.getElementById('lista-os');
            const loading = document.getElementById('loading');
            listaDiv.innerHTML = '';
            
            try {
                // Busca ordenado por data (mais recente primeiro)
                const q = query(collection(db, "ordens_servico"), orderBy("data_criacao", "desc"));
                const querySnapshot = await getDocs(q);
                
                todasOS = [];
                querySnapshot.forEach((doc) => {
                    let dados = doc.data();
                    dados.id = doc.id; // Salva o ID do documento
                    todasOS.push(dados);
                });

                renderizar(todasOS);
                loading.style.display = 'none';

            } catch (error) {
                console.error("Erro:", error);
                loading.innerText = "Erro ao carregar. Verifique o console.";
            }
        }

        // RENDERIZAR NA TELA
        window.renderizar = function(lista) {
            const container = document.getElementById('lista-os');
            container.innerHTML = '';

            if (lista.length === 0) {
                container.innerHTML = '<div style="text-align:center; color:#555;">Nenhuma O.S. encontrada.</div>';
                return;
            }

            lista.forEach(os => {
                // Define status para cor da borda
                let statusClass = 'status-andamento';
                if (os.status?.pago) statusClass = 'status-pago';
                else if (!os.status?.pago && !os.status?.faturado) statusClass = 'status-pendente';

                // Formata Data
                let dataFormatada = "Data desconhecida";
                if (os.data_criacao && os.data_criacao.seconds) {
                    const d = new Date(os.data_criacao.seconds * 1000);
                    dataFormatada = d.toLocaleDateString('pt-BR');
                }

                const html = `
                    <div class="os-card ${statusClass}">
                        <div class="os-info">
                            <div class="os-num">OS #${os.os_numero || '???'}</div>
                            <div class="os-cliente">${os.cliente || 'Sem Nome'}</div>
                            <div class="os-servico">${os.servico_titulo || 'Servi√ßo Gen√©rico'}</div>
                            <div class="os-data">Criado em: ${dataFormatada}</div>
                        </div>
                        <div class="os-valor">${os.valor_restante || 'R$ 0,00'}</div>
                        <div class="actions">
                            <button class="btn-acao btn-abrir" onclick="abrirOS('${os.id}')">‚úèÔ∏è EDITAR</button>
                            <button class="btn-acao btn-del" onclick="deletarOS('${os.id}')">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });
        }

        // FUN√á√ÉO DELETAR
        window.deletarOS = async function(id) {
            if (confirm("Tem certeza que deseja EXCLUIR essa O.S. permanentemente?")) {
                try {
                    await deleteDoc(doc(db, "ordens_servico", id));
                    alert("O.S. exclu√≠da!");
                    carregarLista(); // Recarrega
                } catch (e) {
                    alert("Erro ao excluir: " + e);
                }
            }
        }

        // FUN√á√ÉO FILTRAR
        window.filtrar = function(tipo, btn) {
            // Atualiza bot√µes
            document.querySelectorAll('.btn-filtro').forEach(b => b.classList.remove('ativo'));
            btn.classList.add('ativo');

            if (tipo === 'todos') {
                renderizar(todasOS);
            } else if (tipo === 'pago') {
                const filtrados = todasOS.filter(os => os.status?.pago === true);
                renderizar(filtrados);
            } else if (tipo === 'pendente') {
                const filtrados = todasOS.filter(os => !os.status?.pago);
                renderizar(filtrados);
            }
        }

        // FUN√á√ÉO ABRIR (Redireciona para o os.html com o ID na URL)
        window.abrirOS = function(id) {
            window.location.href = `os.html?id=${id}`;
        }

        // Inicia carregando
        carregarLista();
    </script>
</body>
</html>
